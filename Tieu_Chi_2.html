<!DOCTYPE html>
<html lang="vi">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>T·ªïng Quan Chi Nh√°nh</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50 min-h-screen py-10">
      <div class="max-w-5xl mx-auto px-4">
            <div class="bg-white rounded-lg shadow p-6">
                  <h2 class="text-xl sm:text-2xl font-semibold text-blue-700 mb-4 flex items-center">
                        <i class="fas fa-chart-column mr-2"></i> T·ªîNG H·ª¢P ƒê√ÅNH GI√Å THEO CHI NH√ÅNH
                  </h2>
                  <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-medium mb-1">Ch·ªçn c√°c file ƒë√°nh gi√° nh√¢n vi√™n
                              trong chi nh√°nh</label>
                        <input type="file" id="summaryFiles" accept=".xlsx" multiple class="hidden">
                        <button id="chooseSummaryFilesBtn"
                              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded btn-hover">
                              <i class="fas fa-folder-open mr-1"></i> Ch·ªçn File
                        </button>
                        <div id="fileListDisplay"
                              class="mt-2 space-y-1 text-sm text-gray-700 max-h-[160px] overflow-y-auto pr-1"></div>

                        <p class="text-xs text-gray-500 mt-1">Ch·ªâ h·ªó tr·ª£ file Excel .xlsx</p>
                  </div>
                  <button id="generateSummaryBtn"
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 mt-3 rounded btn-hover">
                        <i class="fas fa-chart-pie mr-1"></i> T·∫°o B√°o C√°o T·ªïng H·ª£p
                  </button>
                  <button id="exportExcelBtn"
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 mt-3 rounded btn-hover">
                        <i class="fas fa-file-export mr-1"></i> Xu·∫•t b√°o c√°o Excel
                  </button>
                  <button id="resetPageBtn"
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 mt-3 rounded btn-hover">
                        <i class="fas fa-rotate-left mr-1"></i> L√†m m·ªõi
                  </button>


            </div>
            <div id="branchReportContainer" class="mt-8 hidden">formatter
                  <h3 class="text-lg font-semibold text-gray-800 mb-3">B√°o c√°o t√¨nh h√¨nh chi nh√°nh</h3>
                  <div class="overflow-x-auto max-h-[320px] overflow-y-auto rounded border border-gray-300">
                        <table class="min-w-full bg-white rounded shadow text-sm">
                              <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                          <th class="py-2 px-4 bg-blue-600">STT</th>
                                          <th class="py-2 px-4 bg-blue-600">Email ng∆∞·ªùi gi√°m s√°t</th>
                                          <th class="py-2 px-4 bg-blue-600">T√™n nh√¢n vi√™n</th>
                                          <th class="py-2 px-4 bg-blue-600">Email</th>
                                          <th class="py-2 px-4 bg-blue-600">Chi nh√°nh</th>
                                          <th class="py-2 px-4 bg-blue-600">Ng√†y ƒë√°nh gi√°</th>
                                          <th class="py-2 px-4 bg-blue-600">T·ªïng ti√™u ch√≠</th>
                                          <th class="py-2 px-4 bg-blue-600">C√ì</th>
                                          <th class="py-2 px-4 bg-blue-600">KH√îNG</th>
                                          <th class="py-2 px-4 bg-blue-600">CH∆ØA KI·ªÇM TRA</th>
                                    </tr>
                              </thead>
                              <tbody id="branchReportBody"></tbody>
                        </table>
                  </div>
            </div>

            <div id="chartContainer" class="mt-8 hidden">
                  <h3 class="text-lg font-semibold text-gray-800 mb-3">Bi·ªÉu ƒë·ªì ƒë√°nh gi√° theo nh√¢n vi√™n</h3>
                  <canvas id="branchBarChart" class="bg-white p-4 rounded shadow"></canvas>
            </div>

            <div id="summaryTableContainer" class="mt-8 hidden">
                  <h3 class="text-lg font-semibold text-gray-800 mb-3">T·ªïng h·ª£p ƒë√°nh gi√° theo danh m·ª•c 1</h3>
                  <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded shadow text-sm">
                              <thead>
                                    <tr class="bg-blue-700 text-white">
                                          <th class="py-2 px-4 text-left">Danh m·ª•c 1</th>
                                          <th class="py-2 px-4 text-center">C√ì (ƒë·∫°t y√™u c·∫ßu)</th>
                                          <th class="py-2 px-4 text-center">KH√îNG (ch∆∞a ƒë·∫°t y√™u c·∫ßu)</th>
                                          <th class="py-2 px-4 text-center">CH∆ØA KI·ªÇM TRA</th>
                                    </tr>
                              </thead>
                              <tbody id="summaryTableBody"></tbody>
                        </table>
                  </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì tr√≤n theo t·ª´ng danh m·ª•c -->
            <div id="pieChartContainer" class="mt-8 hidden"></div>
      </div>

      <script>
            const chooseSummaryFilesBtn = document.getElementById('chooseSummaryFilesBtn');
            const summaryFilesInput = document.getElementById('summaryFiles');
            const fileListDisplay = document.getElementById('fileListDisplay');
            const chartContainer = document.getElementById('chartContainer');
            const summaryTableContainer = document.getElementById('summaryTableContainer');
            const summaryTableBody = document.getElementById('summaryTableBody');

            let selectedFiles = new Map();
            let selectedBranch = null;
            chooseSummaryFilesBtn.addEventListener('click', () => summaryFilesInput.click());
            document.getElementById("resetPageBtn").addEventListener("click", () => {
                  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m m·ªõi to√†n b·ªô trang?")) {
                        location.reload();
                  }
            });

            document.getElementById("exportExcelBtn").addEventListener("click", async () => {
                  const workbook = new ExcelJS.Workbook();
                  const sheet = workbook.addWorksheet("Thong Ke Chi Nhan");

                  const canvas1 = document.getElementById("branchBarChart");
                  const pieCanvases = document.querySelectorAll("#pieChartContainer canvas");

                  // ‚úÖ ƒê·ªãnh nghƒ©a H√ÄM tr∆∞·ªõc khi s·ª≠ d·ª•ng
                  const addImageFromCanvas = async (canvas, rowOffset) => {
                        const dataUrl = canvas.toDataURL("image/png");
                        const base64 = dataUrl.split(',')[1];
                        const binary = atob(base64);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

                        const imageId = workbook.addImage({
                              buffer: bytes,
                              extension: 'png'
                        });

                        sheet.addImage(imageId, {
                              tl: { col: colOffset, row: rowOffset },
                              ext: { width: 320, height: 240 }  // ‚úÖ c·ªë ƒë·ªãnh k√≠ch th∆∞·ªõc pixel
                        });


                        // T·∫°o kho·∫£ng tr·ªëng sau ·∫£nh
                        for (let i = 0; i < 14; i++) sheet.addRow([]);
                  };

                  // üü¶ T√™n chi nh√°nh
                  // L·∫•y t√™n chi nh√°nh t·ª´ d√≤ng ƒë·∫ßu ti√™n c√≥ s·∫µn trong b·∫£ng
                  const firstBranchRow = document.querySelector("#branchReportBody tr");
                  const branchNameRaw = firstBranchRow?.querySelector("td:nth-child(5)")?.textContent || "ChiNhanh";
                  const branchName = branchNameRaw.replace(/[^a-zA-Z√Ä-·ªπ0-9 ]/g, "");


                  // L·∫•y ng√†y hi·ªán t·∫°i ƒë·ªãnh d·∫°ng dd-MM-yyyy
                  // const today = new Date();
                  // const dateStr = today.toLocaleDateString('vi-VN').replaceAll('/', '-');
                  const now = new Date();
                  const yyyy = now.getFullYear();
                  const mm = String(now.getMonth() + 1).padStart(2, '0');
                  const dd = String(now.getDate()).padStart(2, '0');

                  // G·ªôp t√™n file
                  const fileName = `ThongKeChiNhanh_${branchName}_${yyyy}-${mm}-${dd}.xlsx`;
                  const titleRow = sheet.addRow([branchName]);
                  sheet.mergeCells(`A1:I1`);
                  titleRow.font = { bold: true, size: 14, color: { argb: 'FF1F4E78' } };
                  titleRow.alignment = { horizontal: 'center' };

                  // üü¶ Header b·∫£ng
                  const header = ["STT", "Email Ng∆∞·ªùi Gi√°m S√°t", "T√™n nh√¢n vi√™n", "Email", "Chi nh√°nh", "Ng√†y ƒë√°nh gi√°", "T·ªïng ti√™u ch√≠", "C√ì", "KH√îNG", "CH∆ØA KI·ªÇM TRA"]
                  const headerRow = sheet.addRow(header);
                  // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô r·ªông cho t·ª´ng c·ªôt
                  sheet.columns.forEach(column => {
                        let maxLength = 0;
                        column.eachCell({ includeEmpty: true }, cell => {
                              const cellLength = cell.value ? cell.value.toString().length : 0;
                              maxLength = Math.max(maxLength, cellLength);
                        });
                        column.width = maxLength + 2; // c·ªông th√™m padding
                  });

                  headerRow.font = { bold: true, color: { argb: "FFFFFFFF" } };
                  const headerFill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF0070C0' }
                  };

                  for (let i = 1; i <= header.length; i++) {
                        const cell = headerRow.getCell(i);
                        cell.fill = headerFill;
                  }

                  headerRow.alignment = { horizontal: 'center' };
                  //D·ªØ li·ªáu b·∫£ng
                  let index = 1;
                  document.querySelectorAll("#branchReportBody tr").forEach(tr => {
                        const tds = tr.querySelectorAll("td");
                        const rowData = [
                              index++,
                              `${tds[1].textContent.trim()}`, // Email ng∆∞·ªùi gi√°m s√°t ƒë√£ hi·ªÉn th·ªã ƒë√∫ng
                              tds[2].textContent.trim(), // T√™n nh√¢n vi√™n
                              tds[3].textContent.trim(), // Email
                              tds[4].textContent.trim(), // Chi nh√°nh
                              tds[5].textContent.trim(), // Ng√†y ƒë√°nh gi√°
                              tds[6].textContent.trim(), // T·ªïng ti√™u ch√≠
                              tds[7].textContent.trim(), // C√ì
                              tds[8].textContent.trim(), // KH√îNG
                              tds[9].textContent.trim()  // CH∆ØA KI·ªÇM TRA
                        ];
                        sheet.addRow(rowData);
                  });


                  // üñº Ch√®n bi·ªÉu ƒë·ªì
                  // üñºÔ∏è Ch√®n bi·ªÉu ƒë·ªì c·ªôt (to h∆°n 0.5x)
                  {
                        const chartBarDataUrl = canvas1.toDataURL("image/png");
                        const chartBase64 = chartBarDataUrl.split(',')[1];
                        const chartBinary = atob(chartBase64);
                        const chartBytes = new Uint8Array(chartBinary.length);
                        for (let i = 0; i < chartBinary.length; i++) chartBytes[i] = chartBinary.charCodeAt(i);

                        const chartImgId = workbook.addImage({
                              buffer: chartBytes,
                              extension: 'png'
                        });

                        const chartStartRow = sheet.rowCount + 2;
                        sheet.addImage(chartImgId, {
                              tl: { col: 1, row: chartStartRow },
                              br: { col: 8, row: chartStartRow + 20 } // k√©o ngang h∆°n (t·ª´ col 1 ‚Üí 8)
                        });

                        // üè∑Ô∏è Th√™m t√™n b√™n d∆∞·ªõi ·∫£nh v√† cƒÉn gi·ªØa
                        const labelRow = sheet.getRow(chartStartRow + 21);
                        labelRow.getCell(1).value = "Bi·ªÉu ƒë·ªì ƒë√°nh gi√° theo nh√¢n vi√™n";
                        sheet.mergeCells(`A${chartStartRow + 21}:H${chartStartRow + 21}`); // ƒë·ªìng nh·∫•t d√≤ng
                        labelRow.font = { bold: true, size: 12 };
                        labelRow.alignment = { horizontal: "center" };
                        labelRow.commit();

                        // Ch·ªâ c·∫ßn t·∫°o kho·∫£ng tr·ªëng m·ªôt l·∫ßn sau ·∫£nh + t√™n
                        for (let i = 0; i < 4; i++) sheet.addRow([]);
                  }


                  let rowOffset = sheet.rowCount + 2;
                  let colOffset = 1;
                  let chartPerRow = 3;

                  for (let i = 0; i < pieCanvases.length; i++) {
                        const canvas = pieCanvases[i];
                        const chartName = canvas.parentElement.querySelector('div')?.textContent || `Danh m·ª•c ${i + 1}`;

                        const dataUrl = canvas.toDataURL("image/png");
                        const base64 = dataUrl.split(',')[1];
                        const binary = atob(base64);
                        const bytes = new Uint8Array(binary.length);
                        for (let j = 0; j < binary.length; j++) bytes[j] = binary.charCodeAt(j);

                        const imageId = workbook.addImage({
                              buffer: bytes,
                              extension: 'png'
                        });

                        // V·∫Ω h√¨nh v√†o v·ªã tr√≠ c·ª• th·ªÉ
                        sheet.addImage(imageId, {
                              tl: { col: colOffset, row: rowOffset },
                              ext: { width: 240, height: 240 }  // ‚úÖ gi·ªØ ƒë√∫ng h√¨nh tr√≤n
                        });

                        // Th√™m t√™n b√™n d∆∞·ªõi ·∫£nh
                        const titleRow = sheet.getRow(rowOffset + 13);
                        titleRow.getCell(colOffset + 1).value = chartName;
                        titleRow.getCell(colOffset + 1).font = { bold: true };
                        titleRow.commit();

                        // Di chuy·ªÉn v·ªã tr√≠ h√¨nh ti·∫øp theo
                        colOffset += 4;
                        if ((i + 1) % chartPerRow === 0) {
                              colOffset = 1;
                              rowOffset += 15;
                        }
                  }
                  // ‚úÖ Ch√®n ch√∫ th√≠ch d∆∞·ªõi c√πng b·∫£ng Excel
                  let legendStartRow = sheet.rowCount + 2;
                  const legendItems = [
                        { label: "C√ì", color: "00B050" },            // Xanh l√°
                        { label: "KH√îNG", color: "FF0000" },         // ƒê·ªè
                        { label: "CH∆ØA KI·ªÇM TRA", color: "A5A5A5" }  // X√°m
                  ];

                  sheet.addRow([]); // kho·∫£ng tr·ªëng

                  legendItems.forEach((item, i) => {
                        const row = sheet.getRow(legendStartRow + i);
                        row.getCell(2).value = item.label;
                        row.getCell(2).font = { bold: true };

                        row.getCell(1).fill = {
                              type: 'pattern',
                              pattern: 'solid',
                              fgColor: { argb: `FF${item.color}` }
                        };

                        row.height = 18;
                        row.commit();
                  });


                  const buffer = await workbook.xlsx.writeBuffer();
                  saveAs(new Blob([buffer]), fileName);
            });


            summaryFilesInput.addEventListener('change', () => {
                  const files = Array.from(summaryFilesInput.files);
                  files.forEach(async (file) => {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const parts = file.name.replace(".xlsx", "").split("-");
                        const branch = parts[2] || "N/A";

                        if (!selectedBranch) {
                              selectedBranch = branch;  // L∆∞u chi nh√°nh ƒë·∫ßu ti√™n
                        }

                        if (branch !== selectedBranch) {
                              alert("T·∫•t c·∫£ c√°c file ph·∫£i thu·ªôc c√πng m·ªôt chi nh√°nh.");
                              return;
                        }

                        if (!selectedFiles.has(file.name)) {
                              selectedFiles.set(file.name, file);
                        }

                        renderFileList();
                  });

                  summaryFilesInput.value = '';
                  renderFileList();
            });

            function renderFileList() {
                  fileListDisplay.innerHTML = '';
                  selectedFiles.forEach((file, name) => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center bg-gray-100 px-3 py-1 rounded';
                        const span = document.createElement('span');
                        span.textContent = name;
                        const btn = document.createElement('button');
                        btn.innerHTML = '<i class="fas fa-times text-red-500"></i>';
                        btn.className = 'ml-2 hover:text-red-700';
                        btn.onclick = () => {
                              selectedFiles.delete(name);
                              if (selectedFiles.size === 0) selectedBranch = null;
                              renderFileList();
                        };
                        div.appendChild(span);
                        div.appendChild(btn);
                        fileListDisplay.appendChild(div);
                  });
            }

            function getSummaryFromSheet(sheet, fileName) {
                  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                  // T√°ch d·ªØ li·ªáu t·ª´ t√™n file
                  const parts = fileName.replace(".xlsx", "").split("-");
                  const supervisor = parts[0] || "N/A";      // T√™n nh√¢n vi√™n gi√°m s√°t
                  const email = parts[1] ? `${parts[1]}@gmail.com` : "N/A";       // T√™n nh√¢n vi√™n chi nh√°nh
                  const branch = parts[2] || "N/A";          // Chi nh√°nh
                  const date = parts.slice(3).join("-");          // Ng√†y ƒë√°nh gi√°
                  const fullName = rows[2]?.[1] || "N/A"; // ‚úÖ ƒë√∫ng √¥ B3
                  const resultCounts = { "C√ì": 0, "KH√îNG": 0, "CH∆ØA KI·ªÇM TRA": 0 };
                  const categoryStats = {};

                  for (let i = 7; i < rows.length; i++) {
                        const cat = rows[i]?.[1];
                        const result = rows[i]?.[5]?.toString().trim();
                        if (!cat || !resultCounts.hasOwnProperty(result)) continue;

                        resultCounts[result]++;
                        if (!categoryStats[cat]) categoryStats[cat] = { "C√ì": 0, "KH√îNG": 0, "CH∆ØA KI·ªÇM TRA": 0 };
                        categoryStats[cat][result]++;
                  }

                  return {
                        supervisor,
                        email,
                        fullName,
                        branch,
                        date,
                        ...resultCounts,
                        categoryStats
                  };
            }


            document.getElementById('generateSummaryBtn').addEventListener('click', async () => {
                  const files = Array.from(selectedFiles.values());
                  if (!files.length) return alert('Ch∆∞a ch·ªçn file.');

                  const summaryMap = new Map(); // key = email|branch
                  const categoryTotals = {};
                  const TOTAL_CRITERIA = 115;

                  for (const file of files) {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const { supervisor, fullName, email, branch, date, C√ì, KH√îNG, "CH∆ØA KI·ªÇM TRA": CHUA, categoryStats } = getSummaryFromSheet(sheet, file.name);

                        const key = `${fullName}|${branch}`;

                        if (!summaryMap.has(key)) {
                              summaryMap.set(key, { fullName, email, branch, C√ì: 0, KH√îNG: 0, CHUA: 0, count: 0 });
                        }

                        const r = summaryMap.get(key);

                        r.C√ì += C√ì;

                        r.KH√îNG += KH√îNG;
                        r.CHUA += CHUA;
                        r.count++;

                        for (const [cat, values] of Object.entries(categoryStats)) {
                              if (!categoryTotals[cat]) categoryTotals[cat] = { "C√ì": 0, "KH√îNG": 0, "CH∆ØA KI·ªÇM TRA": 0 };
                              categoryTotals[cat]["C√ì"] += values["C√ì"];
                              categoryTotals[cat]["KH√îNG"] += values["KH√îNG"];
                              categoryTotals[cat]["CH∆ØA KI·ªÇM TRA"] += values["CH∆ØA KI·ªÇM TRA"];
                        }
                  }

                  // Chu·∫©n b·ªã d·ªØ li·ªáu bi·ªÉu ƒë·ªì ph·∫ßn trƒÉm
                  const labels = [];
                  const dataYes = [];
                  const dataNo = [];
                  const dataNA = [];

                  for (const { fullName, branch, C√ì, KH√îNG, CHUA, count } of summaryMap.values()) {
                        labels.push(`${fullName} (${branch})`);
                        dataYes.push(Math.round(((C√ì / count) / TOTAL_CRITERIA) * 10000) / 100);
                        dataNo.push(Math.round(((KH√îNG / count) / TOTAL_CRITERIA) * 10000) / 100);
                        dataNA.push(Math.round(((CHUA / count) / TOTAL_CRITERIA) * 10000) / 100);
                  }

                  const ctx = document.getElementById('branchBarChart').getContext('2d');
                  chartContainer.classList.remove('hidden');
                  new Chart(ctx, {
                        type: 'bar',
                        data: {
                              labels,
                              datasets: [
                                    { label: '% C√ì', data: dataYes, backgroundColor: 'rgba(0, 176, 80, 0.6)' },
                                    { label: '% KH√îNG', data: dataNo, backgroundColor: 'rgba(255, 0, 0, 0.6)' },
                                    { label: '% CH∆ØA KI·ªÇM TRA', data: dataNA, backgroundColor: 'rgba(165, 165, 165, 0.6)' }
                              ]
                        },
                        options: {
                              rotation: -90,
                              circumference: 360,
                              cutout: '60%',
                              responsive: true,
                              plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                          color: '#fff',
                                          font: { weight: 'bold' },
                                          formatter: (value, ctx) => {
                                                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                return value > 0 ? `${Math.round((value / total) * 100)}%` : '';
                                          }
                                    }
                              }
                        }

                  });

                  // T·∫°o bi·ªÉu ƒë·ªì doughnut cho t·ª´ng danh m·ª•c
                  const pieChartContainer = document.getElementById('pieChartContainer');
                  pieChartContainer.innerHTML = ''; // clear c≈©
                  pieChartContainer.classList.remove('hidden');

                  // T·∫°o container grid ch·ª©a c√°c bi·ªÉu ƒë·ªì tr√≤n
                  const pieContainer = document.createElement('div');
                  pieContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6';
                  pieChartContainer.appendChild(pieContainer);

                  // T·∫°o bi·ªÉu ƒë·ªì tr√≤n t·ª´ng danh m·ª•c
                  for (const [cat, vals] of Object.entries(categoryTotals)) {
                        const chartWrapper = document.createElement('div');
                        chartWrapper.className = 'text-center';

                        const canvas = document.createElement('canvas');
                        canvas.className = 'w-full max-w-[280px] h-auto mx-auto';
                        chartWrapper.appendChild(canvas);

                        const title = document.createElement('div');
                        title.className = 'font-semibold text-sm text-gray-800 mt-2';
                        title.textContent = cat;
                        chartWrapper.appendChild(title);

                        pieContainer.appendChild(chartWrapper);

                        new Chart(canvas, {
                              type: 'pie',
                              data: {
                                    labels: ['C√ì', 'KH√îNG', 'CH∆ØA KI·ªÇM TRA'],
                                    datasets: [{
                                          data: [vals["C√ì"], vals["KH√îNG"], vals["CH∆ØA KI·ªÇM TRA"]],
                                          backgroundColor: ['#00B050', '#FF0000', '#A5A5A5']
                                    }]
                              },
                              options: {
                                    responsive: true,
                                    plugins: {
                                          legend: {
                                                display: false
                                          },
                                          datalabels: {
                                                color: '#fff',
                                                font: {
                                                      weight: 'bold'
                                                },
                                                formatter: (value, ctx) => {
                                                      const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                      return value > 0
                                                            ? `${((value / total) * 100).toFixed(2)}%`
                                                            : '';
                                                }
                                          }
                                    }
                              },
                              plugins: [ChartDataLabels]  // ‚úÖ B·∫≠t plugin
                        });


                  }

                  // ‚úÖ T·∫°o ch√∫ th√≠ch chung b√™n d∆∞·ªõi
                  const legendWrapper = document.createElement('div');
                  legendWrapper.className = 'flex justify-center items-center gap-6 mt-6 flex-wrap text-sm text-gray-800 font-medium';

                  const legends = [
                        { color: '#00B050', label: 'C√ì' },
                        { color: '#FF0000', label: 'KH√îNG' },
                        { color: '#A5A5A5', label: 'CH∆ØA KI·ªÇM TRA' }
                  ];

                  legends.forEach(({ color, label }) => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center gap-2';

                        const box = document.createElement('div');
                        box.className = 'w-4 h-4 rounded';
                        box.style.backgroundColor = color;

                        const text = document.createElement('span');
                        text.textContent = label;

                        item.appendChild(box);
                        item.appendChild(text);
                        legendWrapper.appendChild(item);
                  });

                  pieChartContainer.appendChild(legendWrapper);

                  // Hi·ªÉn th·ªã b·∫£ng b√°o c√°o chi nh√°nh
                  const branchReportContainer = document.getElementById('branchReportContainer');
                  const branchReportBody = document.getElementById('branchReportBody');
                  branchReportBody.innerHTML = '';
                  branchReportContainer.classList.remove('hidden');

                  let index = 1; // Kh·ªüi t·∫°o STT
                  for (const file of files) {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const { supervisor, fullName, email, branch, date, C√ì, KH√îNG, "CH∆ØA KI·ªÇM TRA": CHUA } = getSummaryFromSheet(sheet, file.name);

                        const row = document.createElement('tr');
                        row.className = 'border-b';

                        row.innerHTML = `
        <td class="py-2 px-4 text-center">${index}</td>
        <td class="py-2 px-4">${supervisor}@gmail.com</td>
        <td class="py-2 px-4">${fullName}</td> 
        <td class="py-2 px-4">${email}</td>
        <td class="py-2 px-4">${branch}</td>
        <td class="py-2 px-4">${date}</td>
        <td class="py-2 px-4 text-center">${TOTAL_CRITERIA}</td>
        <td class="py-2 px-4 text-center">${C√ì}</td>
        <td class="py-2 px-4 text-center">${KH√îNG}</td>
        <td class="py-2 px-4 text-center">${CHUA}</td>
    `;

                        branchReportBody.appendChild(row);
                        index++;
                  }


            });
      </script>
</body>

</html>