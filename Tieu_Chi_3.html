<!DOCTYPE html>
<html lang="vi">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Thống Kê dữ liệu Người Giám Sát</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
      <style>
            .dropzone {
                  border: 2px dashed #cbd5e0;
                  transition: all 0.3s ease;
            }

            .dropzone.active {
                  border-color: #4299e1;
                  background-color: #ebf8ff;
            }

            .file-item:hover {
                  background-color: #f7fafc;
            }

            /* Custom scrollbar */
            .custom-scroll::-webkit-scrollbar {
                  width: 8px;
                  height: 8px;
            }

            .custom-scroll::-webkit-scrollbar-track {
                  background: #f1f1f1;
            }

            .custom-scroll::-webkit-scrollbar-thumb {
                  background: #cbd5e0;
                  border-radius: 4px;
            }

            .custom-scroll::-webkit-scrollbar-thumb:hover {
                  background: #a0aec0;
            }
      </style>
</head>

<body class="bg-gray-50 min-h-screen py-10">
      <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white">
                  <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-chart-bar mr-3"></i>
                        Thống Kê Theo Người Giám Sát
                  </h1>
                  <p class="mt-2 opacity-90">Tải lên các file đánh giá để thống kê kết quả</p>
            </div>
            <!-- Main Content test -->
            <!-- Main Content -->
            <div class="p-6">
                  <!-- File Upload Section -->
                  <div class="mb-8">
                        <div id="dropzone"
                              class="dropzone rounded-lg p-6 text-center cursor-pointer transition-all duration-300 hover:shadow-md">
                              <div class="flex flex-col items-center justify-center py-8">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-3"></i>
                                    <p class="text-lg font-medium text-gray-700">Kéo thả file Excel vào đây hoặc</p>
                                    <label for="fileInput"
                                          class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg cursor-pointer transition duration-300 transform hover:scale-105">
                                          <i class="fas fa-folder-open mr-2"></i>Chọn file
                                    </label>
                                    <input type="file" id="fileInput" class="hidden" multiple accept=".xlsx,.xls">
                              </div>
                        </div>

                        <!-- File List -->
                        <div id="fileList"
                              class="mt-4 bg-gray-50 rounded-lg border border-gray-200 max-h-48 overflow-y-auto custom-scroll hidden">
                              <div class="p-3 border-b border-gray-200 bg-gray-100 text-gray-600 font-medium">
                                    <div class="grid grid-cols-12 gap-2">
                                          <div class="col-span-5">Tên file</div>
                                          <div class="col-span-3">Người giám sát</div>
                                          <div class="col-span-3">Ngày đánh giá</div>
                                          <div class="col-span-1 text-center">Xóa</div>
                                    </div>
                              </div>
                              <div id="fileItemsContainer" class="divide-y divide-gray-200"></div>
                        </div>

                        <div id="emailError" class="text-red-500 mt-2 hidden">
                              <i class="fas fa-exclamation-circle mr-1"></i>
                              <span id="emailErrorMessage"></span>
                        </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="flex flex-wrap gap-4 mb-8">
                        <button id="processBtn"
                              class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg flex items-center transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:transform-none"
                              disabled>
                              <i class="fas fa-cogs mr-2"></i>Xử lý dữ liệu
                        </button>
                        <button id="exportBtn"
                              class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg flex items-center transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:transform-none"
                              disabled>
                              <i class="fas fa-file-excel mr-2"></i>Xuất File Excel
                        </button>
                  </div>

                  <!-- Results Section -->
                  <div id="resultsSection" class="hidden">
                        <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2 flex items-center">
                              <i class="fas fa-table mr-2"></i>Kết quả thống kê
                        </h2>

                        <div class="mb-4">
                              <div class="flex items-center">
                                    <span class="font-medium text-gray-700 mr-2">Người giám sát:</span>
                                    <span id="supervisorNameDisplay" class="text-blue-600 font-medium"></span>
                              </div>
                              <div class="flex items-center">
                                    <span class="font-medium text-gray-700 mr-2">Email:</span>
                                    <span id="supervisorEmailDisplay" class="text-blue-600"></span>
                              </div>
                        </div>

                        <div class="overflow-x-auto custom-scroll">
                              <table id="resultsTable" class="min-w-full bg-white rounded-lg overflow-hidden shadow">
                                    <thead class="bg-gray-800 text-white">
                                          <tr>
                                                <th class="py-3 px-4 text-left">STT</th>
                                                <th class="py-3 px-4 text-left">Ngày đánh giá</th>
                                                <th class="py-3 px-4 text-left">Tên nhân viên</th>
                                                <th class="py-3 px-4 text-left">Email nhân viên</th>
                                                <th class="py-3 px-4 text-left">Chi nhánh</th>
                                                <th class="py-3 px-4 text-center">Tổng TC</th>
                                                <th class="py-3 px-4 text-center">CÓ</th>
                                                <th class="py-3 px-4 text-center">KHÔNG</th>
                                                <th class="py-3 px-4 text-center">Chưa KT</th>
                                          </tr>
                                    </thead>
                                    <tbody id="resultsBody" class="divide-y divide-gray-200">
                                          <!-- Results will be populated here -->
                                    </tbody>
                                    <tfoot class="bg-gray-100 font-semibold">
                                          <tr>
                                                <td class="py-3 px-4" colspan="5">TỔNG CỘNG</td>
                                                <td id="totalCount" class="py-3 px-4 text-center">0</td>
                                                <td id="totalCo" class="py-3 px-4 text-center text-green-600">0</td>
                                                <td id="totalKhong" class="py-3 px-4 text-center text-red-600">0</td>
                                                <td id="totalChua" class="py-3 px-4 text-center text-yellow-600">0</td>
                                          </tr>
                                    </tfoot>
                              </table>
                        </div>
                  </div>
                  <!-- Biểu đồ tròn từng danh mục -->
                  <div id="pieChartContainer" class="mt-10 hidden"></div>

            </div>
      </div>

      <script>
            // Global variables to store processed data
            let processedData = {
                  supervisorEmail: '',
                  supervisorName: '',
                  dataRows: [],
                  totalCo: 0,
                  totalKhong: 0,
                  totalChua: 0
            };

            // DOM Elements
            const fileInput = document.getElementById('fileInput');
            const fileList = document.getElementById('fileList');
            const fileItemsContainer = document.getElementById('fileItemsContainer');
            const dropzone = document.getElementById('dropzone');
            const processBtn = document.getElementById('processBtn');
            const exportBtn = document.getElementById('exportBtn');
            const resultsSection = document.getElementById('resultsSection');
            const resultsBody = document.getElementById('resultsBody');
            const emailError = document.getElementById('emailError');
            const emailErrorMessage = document.getElementById('emailErrorMessage');
            const supervisorNameDisplay = document.getElementById('supervisorNameDisplay');
            const supervisorEmailDisplay = document.getElementById('supervisorEmailDisplay');
            const totalCountEl = document.getElementById('totalCount');
            const totalCoEl = document.getElementById('totalCo');
            const totalKhongEl = document.getElementById('totalKhong');
            const totalChuaEl = document.getElementById('totalChua');

            // Store files and their metadata
            const filesMetadata = [];

            // Event Listeners
            fileInput.addEventListener('change', handleFiles);
            processBtn.addEventListener('click', processFiles);
            exportBtn.addEventListener('click', exportExcel);

            // Drag and drop events
            dropzone.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  dropzone.classList.add('active');
            });

            dropzone.addEventListener('dragleave', () => {
                  dropzone.classList.remove('active');
            });

            dropzone.addEventListener('drop', (e) => {
                  e.preventDefault();
                  dropzone.classList.remove('active');
                  fileInput.files = e.dataTransfer.files;
                  handleFiles();
            });

            // Function to handle file selection
            function handleFiles() {
                  const files = Array.from(fileInput.files);
                  if (files.length === 0) return;

                  // Clear previous files and errors
                  fileItemsContainer.innerHTML = '';
                  hideEmailError();

                  // Process each file and add to the file list
                  files.forEach((file, index) => {
                        // Check if file is already added
                        if (filesMetadata.some(f => f.file.name === file.name)) {
                              return;
                        }

                        const fileName = file.name;
                        const dateStr = extractDateStr(fileName);

                        // Add metadata to array
                        filesMetadata.push({
                              file,
                              index,
                              fileName,
                              dateStr
                        });
                  });

                  // Update file list UI
                  renderFileList();

                  // Enable process button if we have files
                  toggleProcessButton();
            }

            // Function to render the file list
            function renderFileList() {
                  fileItemsContainer.innerHTML = '';

                  filesMetadata.forEach((fileMeta, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item p-3 hover:bg-gray-50 transition-colors';
                        fileItem.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 items-center">
                        <div class="col-span-5 truncate text-gray-700" title="${fileMeta.fileName}">${fileMeta.fileName}</div>
                        <div class="col-span-3 truncate text-gray-600">${extractSupervisorEmail(fileMeta.fileName) || 'Chưa xác định'}</div>
                        <div class="col-span-3 text-gray-500">${fileMeta.dateStr || 'N/A'}</div>
                        <div class="col-span-1 text-center">
                            <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 focus:outline-none">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                        fileItemsContainer.appendChild(fileItem);
                  });

                  fileList.classList.toggle('hidden', filesMetadata.length === 0);
            }
            //draw circle chart
            function renderPieCharts() {
                  const container = document.getElementById('pieChartContainer');
                  container.innerHTML = ''; // Xóa biểu đồ cũ nếu có
                  container.classList.remove('hidden');

                  const grid = document.createElement('div');
                  grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
                  container.appendChild(grid);

                  Object.entries(processedData.categoryStats).forEach(([cat, vals], i) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'text-center';

                        const canvas = document.createElement('canvas');
                        canvas.id = `chart${i + 1}`;
                        canvas.className = 'w-full max-w-[260px] h-auto mx-auto';
                        wrapper.appendChild(canvas);

                        const title = document.createElement('div');
                        title.className = 'font-semibold text-sm text-gray-800 mt-2';
                        title.textContent = cat;
                        wrapper.appendChild(title);

                        grid.appendChild(wrapper);

                        new Chart(canvas, {
                              type: 'pie',
                              data: {
                                    labels: ['CÓ', 'KHÔNG', 'CHƯA KIỂM TRA'],
                                    datasets: [{
                                          data: [vals["CÓ"], vals["KHÔNG"], vals["CHƯA KIỂM TRA"]],
                                          backgroundColor: ['#00B050', '#FF0000', '#A5A5A5']
                                    }]
                              },
                              options: {
                                    responsive: true,
                                    plugins: {
                                          legend: { display: false },
                                          datalabels: {
                                                color: '#fff',
                                                font: { weight: 'bold' },
                                                formatter: (value, ctx) => {
                                                      const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                      return value > 0 ? `${((value / total) * 100).toFixed(2)}%` : '';
                                                }
                                          }
                                    }
                              },
                              plugins: [ChartDataLabels]
                        });
                  });

                  // ✅ Chú thích màu dưới cùng
                  const legend = document.createElement('div');
                  legend.className = 'flex justify-center gap-6 mt-6 flex-wrap text-sm text-gray-800 font-medium';
                  const colors = [
                        { label: "CÓ", color: "#00B050" },
                        { label: "KHÔNG", color: "#FF0000" },
                        { label: "CHƯA KIỂM TRA", color: "#A5A5A5" }
                  ];

                  colors.forEach(({ label, color }) => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center gap-2';
                        item.innerHTML = `<div class="w-4 h-4 rounded" style="background-color:${color}"></div><span>${label}</span>`;
                        legend.appendChild(item);
                  });

                  container.appendChild(legend);
            }


            // Function to remove a file
            function removeFile(index) {
                  filesMetadata.splice(index, 1);
                  renderFileList();
                  toggleProcessButton();
            }

            // Function to toggle process button state
            function toggleProcessButton() {
                  processBtn.disabled = filesMetadata.length === 0;
            }

            // Function to extract supervisor email from filename
            function extractSupervisorEmail(filename) {
                  const parts = filename.split('-');
                  return parts.length > 1 ? parts[0] : '';
            }

            // Function to extract date from filename
            function extractDateStr(filename) {
                  const match = filename.match(/\d{4}-\d{2}-\d{2}/);
                  if (!match) return '';
                  const [y, m, d] = match[0].split('-');
                  return `${d}/${m}/${y}`;
            }

            // Function to show email error
            function showEmailError(message) {
                  emailErrorMessage.textContent = message;
                  emailError.classList.remove('hidden');
                  setTimeout(() => {
                        emailError.classList.add('hidden');
                  }, 5000);
            }


            // Function to hide email error
            function hideEmailError() {
                  emailError.classList.add('hidden');
            }

            // Main processing function
            async function processFiles() {
                  if (filesMetadata.length === 0) return;

                  processBtn.disabled = true;
                  processBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';

                  try {
                        processedData = {
                              supervisorEmail: '',
                              supervisorName: '',
                              dataRows: [],
                              totalCo: 0,
                              totalKhong: 0,
                              totalChua: 0
                        };

                        for (const [index, fileMeta] of filesMetadata.entries()) {
                              try {
                                    const file = fileMeta.file;
                                    const data = await file.arrayBuffer();
                                    const workbook = XLSX.read(data, { type: 'array' });
                                    const sheet = workbook.Sheets[workbook.SheetNames[0]];

                                    // Get supervisor email from cell B2
                                    const currentEmail = sheet['B2']?.v || '';
                                    if (!currentEmail) {
                                          showEmailError(`File ${file.name}: Thiếu email người giám sát ở ô B2`);
                                          continue;
                                    }

                                    // Check email consistency
                                    if (index === 0) {
                                          processedData.supervisorEmail = currentEmail;
                                          processedData.supervisorName = sheet['B1']?.v || 'Không xác định';
                                    } else if (currentEmail !== processedData.supervisorEmail) {
                                          showEmailError(`File ${file.name}: Email người giám sát không khớp với file đầu tiên (${processedData.supervisorEmail} ≠ ${currentEmail})`);
                                          return;
                                    }

                                    // Process employee data
                                    const employeeName = sheet['B3']?.v || '';
                                    const employeeEmail = sheet['B4']?.v || '';
                                    const branch = sheet['B5']?.v || '';

                                    // Count results
                                    let total = 0, co = 0, khong = 0, chua = 0;
                                    for (let row = 9; ; row++) {
                                          const sttCell = sheet[`A${row}`];
                                          if (!sttCell || sttCell.v === undefined) break;

                                          const result = (sheet[`F${row}`]?.v || '').toUpperCase();
                                          if (result === 'CÓ') co++;
                                          else if (result === 'KHÔNG') khong++;
                                          else chua++;

                                          total++;
                                    }

                                    processedData.dataRows.push({
                                          date: fileMeta.dateStr,
                                          name: employeeName,
                                          email: employeeEmail,
                                          branch: branch,
                                          total: total,
                                          co: co,
                                          khong: khong,
                                          chua: chua
                                    });
                                    if (!processedData.categoryStats) processedData.categoryStats = {};

                                    for (let row = 9; ; row++) {
                                          const sttCell = sheet[`A${row}`];
                                          if (!sttCell || sttCell.v === undefined) break;

                                          const cat = sheet[`B${row}`]?.v?.trim();
                                          const result = (sheet[`F${row}`]?.v || '').toUpperCase();
                                          if (!cat) continue;

                                          if (!processedData.categoryStats[cat]) {
                                                processedData.categoryStats[cat] = { "CÓ": 0, "KHÔNG": 0, "CHƯA KIỂM TRA": 0 };
                                          }

                                          if (result === 'CÓ') processedData.categoryStats[cat]["CÓ"]++;
                                          else if (result === 'KHÔNG') processedData.categoryStats[cat]["KHÔNG"]++;
                                          else processedData.categoryStats[cat]["CHƯA KIỂM TRA"]++;
                                    }


                                    // Update totals
                                    processedData.totalCo += co;
                                    processedData.totalKhong += khong;
                                    processedData.totalChua += chua;

                              } catch (e) {
                                    console.error(`Error processing file ${fileMeta.file.name}:`, e);
                                    showEmailError(`Lỗi xử lý file ${fileMeta.file.name}: ${e.message}`);
                              }
                        }

                        if (processedData.dataRows.length > 0) {
                              renderResults();
                              renderPieCharts();
                              exportBtn.disabled = false;
                              resultsSection.classList.remove('hidden');
                        }

                  } catch (e) {
                        console.error('Error in processFiles:', e);
                        showEmailError(`Lỗi: ${e.message}`);
                  } finally {
                        processBtn.disabled = false;
                        processBtn.innerHTML = '<i class="fas fa-cogs mr-2"></i>Xử lý dữ liệu';
                  }
            }

            // Function to render results to the table
            function renderResults() {
                  resultsBody.innerHTML = '';

                  // Update supervisor info
                  supervisorNameDisplay.textContent = processedData.supervisorName;
                  supervisorEmailDisplay.textContent = processedData.supervisorEmail;

                  // Add rows to table
                  processedData.dataRows.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        tr.innerHTML = `
                    <td class="py-3 px-4 text-gray-700">${index + 1}</td>
                    <td class="py-3 px-4">${row.date}</td>
                    <td class="py-3 px-4 font-medium">${row.name}</td>
                    <td class="py-3 px-4 text-blue-600">${row.email}</td>
                    <td class="py-3 px-4">${row.branch}</td>
                    <td class="py-3 px-4 text-center">${row.total}</td>
                    <td class="py-3 px-4 text-center text-green-600">${row.co}</td>
                    <td class="py-3 px-4 text-center text-red-600">${row.khong}</td>
                    <td class="py-3 px-4 text-center text-yellow-600">${row.chua}</td>
                `;
                        resultsBody.appendChild(tr);
                  });

                  // Update totals
                  totalCountEl.textContent = processedData.dataRows.reduce((sum, row) => sum + row.total, 0);
                  totalCoEl.textContent = processedData.totalCo;
                  totalKhongEl.textContent = processedData.totalKhong;
                  totalChuaEl.textContent = processedData.totalChua;
            }

            // Function to export to Excel
            async function exportExcel() {
                  if (processedData.dataRows.length === 0) return;

                  exportBtn.disabled = true;
                  exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xuất file...';

                  try {
                        const wb = new ExcelJS.Workbook();
                        const ws = wb.addWorksheet('Thong Ke');

                        // Set up styles
                        const headerStyle = {
                              fill: {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: 'FF2F75B5' }
                              },
                              font: {
                                    bold: true,
                                    color: { argb: 'FFFFFFFF' }
                              },
                              alignment: { vertical: 'middle', horizontal: 'center' },
                              border: {
                                    top: { style: 'thin', color: { argb: 'FF2F75B5' } },
                                    left: { style: 'thin', color: { argb: 'FF2F75B5' } },
                                    bottom: { style: 'thin', color: { argb: 'FF2F75B5' } },
                                    right: { style: 'thin', color: { argb: 'FF2F75B5' } }
                              }
                        };

                        const titleStyle = {
                              font: {
                                    bold: true,
                                    size: 14
                              }
                        };

                        const dataCellStyle = {
                              border: {
                                    top: { style: 'thin', color: { argb: 'FFD9D9D9' } },
                                    left: { style: 'thin', color: { argb: 'FFD9D9D9' } },
                                    bottom: { style: 'thin', color: { argb: 'FFD9D9D9' } },
                                    right: { style: 'thin', color: { argb: 'FFD9D9D9' } }
                              },
                              alignment: { vertical: 'middle' }
                        };

                        const centerAligned = {
                              ...dataCellStyle,
                              alignment: { vertical: 'middle', horizontal: 'center' }
                        };

                        // Set column widths
                        ws.columns = [
                              { width: 13 },  // STT
                              { width: 15 }, // Ngày đánh giá
                              { width: 25 }, // Tên nhân viên
                              { width: 25 }, // Email nhân viên
                              { width: 20 }, // Chi nhánh
                              { width: 20 }, // Tổng TC
                              { width: 13 }, // CÓ
                              { width: 13 }, // KHÔNG
                              { width: 20 }  // Chưa KT
                        ];

                        // Add title rows
                        const titleRow1 = ws.addRow([`THỐNG KÊ ĐÁNH GIÁ THEO NGƯỜI GIÁM SÁT`]);
                        titleRow1.getCell(1).style = titleStyle;
                        titleRow1.font = { bold: true, size: 14 };
                        ws.mergeCells('A1:I1');

                        const titleRow2 = ws.addRow([`Tên người giám sát: ${processedData.supervisorName}`]);
                        titleRow2.getCell(1).style = { ...dataCellStyle, font: { bold: true } };
                        ws.mergeCells('A2:I2');

                        const titleRow3 = ws.addRow([`Email người giám sát: ${processedData.supervisorEmail}`]);
                        titleRow3.getCell(1).style = { ...dataCellStyle, font: { bold: true } };
                        ws.mergeCells('A3:I3');

                        ws.addRow(['']); // Empty row

                        // Add headers
                        const headers = [
                              'STT',
                              'Ngày đánh giá',
                              'Tên nhân viên',
                              'Email nhân viên',
                              'Chi nhánh',
                              'Tổng tiêu chí đánh giá',
                              'Tổng CÓ',
                              'Tổng KHÔNG',
                              'Tổng Chưa Kiểm Tra'
                        ];

                        const headerRow = ws.addRow(headers);
                        headerRow.eachCell(cell => {
                              cell.style = headerStyle;
                        });

                        // Add data rows
                        processedData.dataRows.forEach((row, index) => {
                              const dataRow = ws.addRow([
                                    index + 1, // STT
                                    row.date,  // Ngày đánh giá
                                    row.name,
                                    row.email,
                                    row.branch,
                                    row.total, // Tổng tiêu chí đánh giá
                                    row.co, // Tổng CÓ
                                    row.khong, // Tổng KHÔNG
                                    row.chua // Tổng Chưa Kiểm Tra
                              ]);

                              // Apply styles
                              dataRow.eachCell((cell, colNumber) => {
                                    // Style mặc định
                                    cell.style = {
                                          border: {
                                                top: { style: 'thin', color: { argb: 'FFD9D9D9' } },
                                                left: { style: 'thin', color: { argb: 'FFD9D9D9' } },
                                                bottom: { style: 'thin', color: { argb: 'FFD9D9D9' } },
                                                right: { style: 'thin', color: { argb: 'FFD9D9D9' } }
                                          },
                                          alignment: { vertical: 'middle', horizontal: 'center' }
                                    };

                                    // STT
                                    if (colNumber === 1) {
                                          cell.fill = {
                                                type: 'pattern',
                                                pattern: 'solid',
                                                fgColor: { argb: 'FFDAEEF3' }  // xanh nhạt
                                          };
                                          cell.font = { color: { argb: 'FF00688B' }, bold: true }; // xanh đậm
                                    }

                                    // Tổng tiêu chí
                                    if (colNumber === 6) {
                                          cell.fill = {
                                                type: 'pattern',
                                                pattern: 'solid',
                                                fgColor: { argb: 'FFFFF2CC' }  // vàng nhạt
                                          };
                                          cell.font = { color: { argb: 'FF7F6000' }, bold: true }; // nâu đậm
                                    }

                                    // Tổng CÓ
                                    if (colNumber === 7) {
                                          cell.fill = {
                                                type: 'pattern',
                                                pattern: 'solid',
                                                fgColor: { argb: 'FFEBF1DE' }  // xanh lá nhạt
                                          };
                                          cell.font = { color: { argb: 'FF00B050' }, bold: true }; // xanh lá đậm
                                    }

                                    // Tổng KHÔNG
                                    if (colNumber === 8) {
                                          cell.fill = {
                                                type: 'pattern',
                                                pattern: 'solid',
                                                fgColor: { argb: 'FFFDE9D9' }  // đỏ nhạt
                                          };
                                          cell.font = { color: { argb: 'FFC00000' }, bold: true }; // đỏ đậm
                                    }

                                    // Tổng Chưa KT
                                    if (colNumber === 9) {
                                          cell.fill = {
                                                type: 'pattern',
                                                pattern: 'solid',
                                                fgColor: { argb: 'FFFFFCEB' }  // vàng kem
                                          };
                                          cell.font = { color: { argb: 'FFFFC000' }, bold: true }; // vàng đậm
                                    }
                              });

                        });

                        // Add summary row
                        ws.addRow(['']);

                        const totalRow = ws.addRow([
                              'TỔNG CỘNG',
                              '',
                              '',
                              '',
                              '',
                              processedData.dataRows.reduce((sum, row) => sum + row.total, 0),
                              processedData.totalCo,
                              processedData.totalKhong,
                              processedData.totalChua
                        ]);

                        totalRow.eachCell((cell, colNumber) => {
                              cell.style = {
                                    ...dataCellStyle,
                                    font: { bold: true },
                                    fill: {
                                          type: 'pattern',
                                          pattern: 'solid',
                                          fgColor: { argb: 'FFF2F2F2' }
                                    }
                              };

                              if (colNumber >= 6) {
                                    cell.style.alignment = { vertical: 'middle', horizontal: 'center' };
                              }
                              if (colNumber == 7) {
                                    cell.fill = {
                                          type: 'pattern',
                                          pattern: 'solid',
                                          fgColor: { argb: 'FFEBF1DE' }  // xanh lá nhạt
                                    };
                                    cell.font = { color: { argb: 'FF00B050' }, bold: true }; // xanh lá đậm
                              }
                              if (colNumber == 8) {
                                    cell.fill = {
                                          type: 'pattern',
                                          pattern: 'solid',
                                          fgColor: { argb: 'FFFDE9D9' }  // đỏ nhạt
                                    };
                                    cell.font = { color: { argb: 'FFC00000' }, bold: true }; // đỏ đậm
                              }
                        });

                        // Generate filename
                        const now = new Date();
                        const yyyy = now.getFullYear();
                        const mm = String(now.getMonth() + 1).padStart(2, '0');
                        const dd = String(now.getDate()).padStart(2, '0');
                        const cleanEmail = processedData.supervisorEmail.split('@')[0].trim() || 'unknown';
                        const fileName = `ThongKeNguoiGiamSat_${cleanEmail}_${yyyy}-${mm}-${dd}.xlsx`;

                        // === CHÈN 5 BIỂU ĐỒ TRÒN NẾU CÓ
                        let colOffset = 1;
                        let rowOffset = ws.rowCount + 2;
                        let maxRowOffset = rowOffset;   // sau phần bảng
                        const chartCanvases = document.querySelectorAll("#pieChartContainer canvas");

                        // ✅ Đợi tất cả biểu đồ render xong
                        await new Promise(resolve => setTimeout(resolve, 500));

                        chartCanvases.forEach((canvas, i) => {
                              const dataUrl = canvas.toDataURL("image/png");
                              const base64 = dataUrl.split(',')[1];
                              const binary = atob(base64);
                              const bytes = new Uint8Array(binary.length);
                              for (let j = 0; j < binary.length; j++) {
                                    bytes[j] = binary.charCodeAt(j);
                              }

                              const imageId = wb.addImage({
                                    buffer: bytes,
                                    extension: 'png'
                              });

                              ws.addImage(imageId, {
                                    tl: { col: colOffset, row: rowOffset },
                                    ext: { width: 250, height: 250 }
                              });

                              // Thêm tiêu đề biểu đồ
                              // Thêm tiêu đề biểu đồ dưới ảnh
                              const title = canvas.parentElement.querySelector('div').textContent || `Biểu đồ ${i + 1}`;
                              const titleRow = rowOffset + 16; // hoặc +17 nếu ảnh cao hơn

                              // Gộp 3 cột bên dưới ảnh để căn giữa
                              ws.mergeCells(titleRow, colOffset, titleRow, colOffset + 2);
                              const titleCell = ws.getCell(titleRow, colOffset);
                              titleCell.value = title;
                              titleCell.font = { bold: true };
                              titleCell.alignment = { horizontal: 'center', vertical: 'middle' };

                              colOffset += 3;
                              if ((i + 1) % 3 === 0) {
                                    colOffset = 1;
                                    rowOffset += 18;
                              }
                        });

                        // ✅ THÊM CHÚ THÍCH MÀU 1 LẦN SAU BIỂU ĐỒ
                        const legendStartRow = rowOffset + 18;
                        const legendRow = ws.getRow(legendStartRow);
                        legendRow.getCell(1).value = 'CÓ';
                        legendRow.getCell(1).fill = {
                              type: 'pattern',
                              pattern: 'solid',
                              fgColor: { argb: 'FF00B050' }  // xanh lá
                        };

                        legendRow.getCell(2).value = 'KHÔNG';
                        legendRow.getCell(2).fill = {
                              type: 'pattern',
                              pattern: 'solid',
                              fgColor: { argb: 'FFFF0000' }  // đỏ
                        };

                        legendRow.getCell(3).value = 'CHƯA KT';
                        legendRow.getCell(3).fill = {
                              type: 'pattern',
                              pattern: 'solid',
                              fgColor: { argb: 'FFA5A5A5' }  // xám
                        };

                        legendRow.eachCell(cell => {
                              cell.font = { bold: true };
                              cell.alignment = { vertical: 'middle', horizontal: 'center' };
                        });
                        legendRow.height = 20;
                        legendRow.commit();


                        // Save file
                        const buf = await wb.xlsx.writeBuffer();
                        saveAs(new Blob([buf]), fileName);

                  } catch (e) {
                        console.error('Error exporting to Excel:', e);
                        showEmailError(`Lỗi khi xuất Excel: ${e.message}`);
                  } finally {
                        exportBtn.disabled = false;
                        exportBtn.innerHTML = '<i class="fas fa-file-excel mr-2"></i>Xuất Excel';
                  }
            }
      </script>
</body>

</html>