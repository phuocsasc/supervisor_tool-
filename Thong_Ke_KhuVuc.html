<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªëng k√™ d·ªØ li·ªáu Khu V·ª±c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="logoFPT.png" type="image/x-icon">

    <style>
        .active-menu {
            font-weight: 600;
            background: linear-gradient(to right, rgb(255, 255, 255), rgba(189, 230, 237, 0.805));
            color: black !important;

            border-radius: 8px;
            /* t√πy ch·ªçn n·∫øu b·∫°n mu·ªën l√†m m·ªÅm g√≥c */
            transition: background 0.3s ease;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }

        .menu-item {
            color: white;
            font-weight: 600;
        }

        .menu-item:hover {
            font-weight: 600;
            background: linear-gradient(to right, rgb(255, 255, 255), rgba(189, 230, 237, 0.805));
            color: black !important;

            border-radius: 8px;
            /* t√πy ch·ªçn n·∫øu b·∫°n mu·ªën l√†m m·ªÅm g√≥c */
            transition: background 0.3s ease;
        }

        #sidebar {
            transition: all 0.3s;
            box-shadow: rgba(0, 0, 0, 0.24) 5px 8px 18px;


        }

        .admin-bg {
            background-image: url(background_nav.jpg);

            background-size: cover;
            /* co gi√£n ·∫£nh ƒë·ªÉ ph·ªß h·∫øt ph·∫ßn t·ª≠ */
            background-repeat: no-repeat;
            /* kh√¥ng l·∫∑p ·∫£nh */
            background-position: center;
            /* cƒÉn gi·ªØa ·∫£nh n·ªÅn */
        }

        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                position: absolute;
                z-index: 50;
                height: 100vh;
            }

            #sidebar.open {
                transform: translateX(0);
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }

            .overlay.open {
                display: block;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-orange-200 to-white">
    <div class="flex h-screen overflow-hidden">
        <!-- Mobile menu button -->
        <div class="md:hidden fixed top-4 left-4 z-50">
            <button id="menuToggle" class="p-2 rounded-md bg-orange-500 text-white">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Overlay for mobile -->
        <div id="overlay" class="overlay"></div>

        <!-- Sidebar -->
        <div id="sidebar"
            class="sidebar admin-bg text-gray-800 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 shadow-lg">
            <!-- Logo -->
            <div class="flex items-center space-x-2 px-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-8  flex items-center justify-center">
                            <img src="logoFPT.png" alt="">
                        </div>
                    </div>
                </div>
                <span class="text-xl font-bold text-white">QU·∫¢N TR·ªä VI√äN</span>
            </div>

            <!-- Navigation -->
            <nav>
                <div class="space-y-2">
                    <a href="admin.html" class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        Trang Ch·ªß
                    </a>
                    <a href="Truy_xuat_data.html" class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-layer-group mr-3"></i>
                        Gom Nh√≥m D·ªØ Li·ªáu
                    </a>
                    <a href="Thong_Ke_NhanVien.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-users mr-3"></i>
                        Th·ªëng K√™ Nh√¢n Vi√™n
                    </a>
                    <a href="Thong_Ke_NguoiGiamSat.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-user-tie mr-3"></i>
                        Th·ªëng K√™ Ng∆∞·ªùi Gi√°m S√°t
                    </a>
                    <a href="Thong_Ke_ChiNhanh.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-code-branch mr-4"></i>
                        Th·ªëng K√™ Chi Nh√°nh
                    </a>
                    <a href="Thong_Ke_KhuVuc.html"
                        class="active-menu menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-map-marked-alt mr-4"></i>
                        Th·ªëng K√™ Khu V·ª±c
                    </a>
                    <a href="Thong_Ke_ToanQuoc.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-globe-americas mr-4"></i>
                        Th·ªëng K√™ To√†n Qu·ªëc
                    </a>

                </div>
            </nav>

            <!-- Logout button at bottom -->
            <div class="absolute bottom-0 left-0 right-0 p-4">
                <a href="index.html"
                    class="block py-2.5 px-4 rounded transition duration-200 bg-gradient-to-r from-pink-500 to-red-500 text-white hover:from-pink-600 hover:to-red-600 shadow-md hover:shadow-lg">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    Tho√°t
                </a>
            </div>
        </div>


        <!-- Main content -->
        <main class="flex-1 overflow-y-auto p-2">
            <div class="bg-white rounded-lg shadow p-6">
                <!-- N·ªôi dung c·ªßa t·ª´ng tool -->
                <div class="max-w-8xl mx-auto px-2">
                    <div class="bg-white rounded-lg shadow p-4 ">
                        <h1 class="text-3xl font-bold text-orange-600 mb-2">
                            <i class="fas fa-map-marked-alt mr-3"></i>
                            TH·ªêNG K√ä D·ªÆ LI·ªÜU THEO KHU V·ª∞C
                        </h1>
                        <div class="mb-6">
                            <label class="block text-gray-600 text-sm mb-5">
                                T·∫£i l√™n c√°c file Excel d·ªØ li·ªáu cho 1 Khu V·ª±c</label>
                            <input type="file" id="summaryFiles" accept=".xlsx" multiple class="hidden">
                            <button id="chooseSummaryFilesBtn"
                                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded btn-hover">
                                <i class="fas fa-folder-open mr-1"></i> Ch·ªçn File
                            </button>
                            <div id="fileListDisplay"
                                class="mt-2 space-y-1 text-sm text-gray-700 max-h-[160px] overflow-y-auto pr-1">
                            </div>

                            <p class="text-xs text-gray-500 mt-1">Ch·ªâ h·ªó tr·ª£ file Excel .xlsx ƒë√∫ng ƒë·ªãnh
                                d·∫°ng m√† ng∆∞·ªùi gi√°m s√°t cung c·∫•p</p>
                        </div>
                        <!-- Alert l·ªói -->
                        <div id="errorAlert"
                            class="hidden fade-in bg-red-50 border-l-4 border-red-500 p-4 my-4 rounded-r-lg">
                            <div class="flex">
                                <div class="flex-shrink-0 pt-0.5">
                                    <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800" id="errorTitle">C√≥
                                        l·ªói x·∫£y ra</h3>
                                    <div class="mt-2 text-sm text-red-700" id="errorMessage">
                                        <!-- N·ªôi dung l·ªói -->
                                    </div>
                                </div>
                                <button id="closeErrorBtn"
                                    class="ml-auto -mx-1.5 -my-1.5 bg-red-50 rounded-lg p-1.5 inline-flex h-8 w-8 text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>



                        <button id="generateSummaryBtn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 mt-3 rounded btn-hover">
                            <i class="fas fa-chart-pie mr-1"></i> X·ª≠ l√Ω d·ªØ li·ªáu
                        </button>
                        <button id="exportExcelBtn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-2 mt-3 rounded btn-hover">
                            <i class="fas fa-file-export mr-1"></i> Xu·∫•t File Excel
                        </button>
                        <button id="resetPageBtn"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 mt-3 rounded btn-hover">
                            <i class="fas fa-rotate-left mr-1"></i> L√†m m·ªõi
                        </button>


                    </div>
                    <div id="branchReportContainer" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">B√°o c√°o t√¨nh h√¨nh Khu V·ª±c
                        </h3>
                        <div class="overflow-x-auto max-h-[520px] overflow-y-auto rounded border border-gray-300">
                            <table class="min-w-full bg-white rounded shadow text-sm">
                                <thead class="bg-orange-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="py-2 px-4 bg-orange-600">STT</th>
                                        <th class="py-2 px-4 bg-orange-600">Email ng∆∞·ªùi gi√°m s√°t</th>
                                        <th class="py-2 px-4 bg-orange-600">T√™n nh√¢n vi√™n</th>
                                        <th class="py-2 px-4 bg-orange-600">Email Nh√¢n Vi√™n</th>
                                        <th class="py-2 px-4 bg-orange-600">Khu V·ª±c</th>
                                        <th class="py-2 px-4 bg-orange-600">Chi nh√°nh</th>
                                        <th class="py-2 px-4 bg-orange-600">Ng√†y ƒë√°nh gi√°</th>
                                        <th class="py-2 px-4 bg-orange-600">T·ªïng ti√™u ch√≠</th>
                                        <th class="py-2 px-4 bg-orange-600">C√ì</th>
                                        <th class="py-2 px-4 bg-orange-600">KH√îNG</th>
                                        <th class="py-2 px-4 bg-orange-600">CH∆ØA KI·ªÇM TRA</th>
                                    </tr>
                                </thead>
                                <tbody id="branchReportBody"></tbody>
                                <tfoot id="branchReportFooter" class="hidden bg-orange-100 font-semibold text-gray-900">
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div id="chartContainer" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Bi·ªÉu ƒë·ªì ƒë√°nh gi√° theo t·ª´ng chi nh√°nh trong khu v·ª±c
                        </h3>
                        <canvas id="branchBarChart" class="bg-white p-4 rounded shadow"></canvas>
                    </div>

                    <div id="summaryTableContainer" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">T·ªïng h·ª£p ƒë√°nh gi√° theo danh m·ª•c
                            1</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded shadow text-sm">
                                <thead>
                                    <tr class="bg-orange-700 text-white">
                                        <th class="py-2 px-4 text-left">Danh m·ª•c 1</th>
                                        <th class="py-2 px-4 text-center">C√ì (ƒë·∫°t y√™u c·∫ßu)</th>
                                        <th class="py-2 px-4 text-center">KH√îNG (ch∆∞a ƒë·∫°t y√™u c·∫ßu)
                                        </th>
                                        <th class="py-2 px-4 text-center">CH∆ØA KI·ªÇM TRA</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Bi·ªÉu ƒë·ªì tr√≤n theo t·ª´ng danh m·ª•c -->
                    <div id="pieChartContainer" class="mt-8 hidden"></div>
                </div>


            </div>

        </main>

    </div>



    <script>
        let branchChart = null;

        const chooseSummaryFilesBtn = document.getElementById('chooseSummaryFilesBtn');
        const summaryFilesInput = document.getElementById('summaryFiles');
        const fileListDisplay = document.getElementById('fileListDisplay');
        const chartContainer = document.getElementById('chartContainer');
        const summaryTableContainer = document.getElementById('summaryTableContainer');
        const summaryTableBody = document.getElementById('summaryTableBody');

        const errorAlert = document.getElementById('errorAlert');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const closeErrorBtn = document.getElementById('closeErrorBtn');
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        });
        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('open');
        });

        document.querySelectorAll('#sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('overlay').classList.remove('open');
            });
        });
        function showError(title, message) {
            errorTitle.textContent = title;
            errorMessage.innerHTML = message;
            errorAlert.classList.remove('hidden');
            errorAlert.classList.add('fade-in');

            setTimeout(() => {
                errorAlert.classList.add('hidden');
            }, 5000);
        }

        closeErrorBtn?.addEventListener('click', () => {
            errorAlert.classList.add('hidden');
        });

        let selectedFiles = new Map();
        let selectedArea = null;
        let errorSummary = {}; // üü¶ Khai b√°o to√†n c·ª•c

        chooseSummaryFilesBtn.addEventListener('click', () => summaryFilesInput.click());
        document.getElementById("resetPageBtn").addEventListener("click", () => {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m m·ªõi to√†n b·ªô trang?")) {
                location.reload();
            }
        });

        document.getElementById("exportExcelBtn").addEventListener("click", async () => {
            const files = Array.from(selectedFiles.values());
            if (!files.length) return showError('Ch∆∞a ch·ªçn file.');
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet("Thong Ke Chi Nhan");

            const canvas1 = document.getElementById("branchBarChart");
            const pieCanvases = document.querySelectorAll("#pieChartContainer canvas");

            // ‚úÖ ƒê·ªãnh nghƒ©a H√ÄM tr∆∞·ªõc khi s·ª≠ d·ª•ng
            const addImageFromCanvas = async (canvas, rowOffset) => {
                const dataUrl = canvas.toDataURL("image/png");
                const base64 = dataUrl.split(',')[1];
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

                const imageId = workbook.addImage({
                    buffer: bytes,
                    extension: 'png'
                });

                sheet.addImage(imageId, {
                    tl: { col: colOffset, row: rowOffset },
                    ext: { width: 320, height: 240 }  // ‚úÖ c·ªë ƒë·ªãnh k√≠ch th∆∞·ªõc pixel
                });


                // T·∫°o kho·∫£ng tr·ªëng sau ·∫£nh
                for (let i = 0; i < 14; i++) sheet.addRow([]);
            };

            // L·∫•y t√™n chi nh√°nh t·ª´ d√≤ng ƒë·∫ßu ti√™n c√≥ s·∫µn trong b·∫£ng
            const firstBranchRow = document.querySelector("#branchReportBody tr");
            const branchNameRaw = firstBranchRow?.querySelector("td:nth-child(5)")?.textContent || "ChiNhanh";
            const branchName = branchNameRaw.replace(/[^a-zA-Z√Ä-·ªπ0-9 ]/g, "");


            // L·∫•y ng√†y hi·ªán t·∫°i ƒë·ªãnh d·∫°ng dd-MM-yyyy
            // const today = new Date();
            // const dateStr = today.toLocaleDateString('vi-VN').replaceAll('/', '-');
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');

            // G·ªôp t√™n file
            const fileName = `ThongKeKhuVuc_${branchName}_${yyyy}-${mm}-${dd}.xlsx`;
            const titleRow = sheet.addRow([branchName]);
            sheet.mergeCells(`A1:K1`);
            titleRow.font = { bold: true, size: 14, color: { argb: 'FF1F4E78' } };
            titleRow.alignment = { horizontal: 'center' };

            // üü¶ Header b·∫£ng
            const header = ["STT", "Email Ng∆∞·ªùi Gi√°m S√°t", "T√™n nh√¢n vi√™n", "Email", "Khu V·ª±c", "Chi nh√°nh", "Ng√†y ƒë√°nh gi√°", "T·ªïng ti√™u ch√≠", "C√ì", "KH√îNG", "CH∆ØA KI·ªÇM TRA"]
            const headerRow = sheet.addRow(header);
            // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô r·ªông cho t·ª´ng c·ªôt
            sheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 0;
                    maxLength = Math.max(maxLength, cellLength);
                });
                column.width = maxLength + 2; // c·ªông th√™m padding
            });

            headerRow.font = { bold: true, color: { argb: "FFFFFFFF" } };
            const headerFill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF0070C0' }
            };

            for (let i = 1; i <= header.length; i++) {
                const cell = headerRow.getCell(i);
                cell.fill = headerFill;
            }

            headerRow.alignment = { horizontal: 'center' };
            //D·ªØ li·ªáu b·∫£ng
            let index = 1;
            document.querySelectorAll("#branchReportBody tr").forEach(tr => {
                const tds = tr.querySelectorAll("td");
                const rowData = [
                    index++,
                    `${tds[1].textContent.trim()}`, // Email ng∆∞·ªùi gi√°m s√°t ƒë√£ hi·ªÉn th·ªã ƒë√∫ng
                    tds[2].textContent.trim(), // T√™n nh√¢n vi√™n
                    tds[3].textContent.trim(), // Email
                    tds[4].textContent.trim(), // khu v·ª±c
                    tds[5].textContent.trim(),// Chi nh√°nh
                    tds[6].textContent.trim(), // Ng√†y ƒë√°nh gi√°
                    tds[7].textContent.trim(), // T·ªïng ti√™u ch√≠
                    tds[8].textContent.trim(), // C√ì
                    tds[9].textContent.trim(), // KH√îNG
                    tds[10].textContent.trim()  // CH∆ØA KI·ªÇM TRA
                ];
                sheet.addRow(rowData);
                sheet.columns = [
                    { key: 'stt', width: 8 },
                    { key: 'emailGiamSat', width: 25 },
                    { key: 'tenNhanVien', width: 25 },
                    { key: 'emailNV', width: 25 },
                    { key: 'khuVuc', width: 15 },
                    { key: 'chiNhanh', width: 15 },
                    { key: 'ngayDanhGia', width: 15 },
                    { key: 'tongTieuChi', width: 15 },
                    { key: 'co', width: 15 },
                    { key: 'khong', width: 15 },
                    { key: 'chuaKT', width: 22 }
                ];
                // CƒÉn gi·ªØa to√†n b·ªô c·ªôt (t·ª´ A ƒë·∫øn K = 11 c·ªôt)
                for (let i = 1; i <= 11; i++) {
                    sheet.getColumn(i).alignment = { horizontal: 'center', vertical: 'middle', wrapText: false };
                }
            });
            // T√≠nh t·ªïng c√°c c·ªôt
            let totalCriteriaSum = 0, coSum = 0, khongSum = 0, chuaSum = 0;

            document.querySelectorAll("#branchReportBody tr").forEach(tr => {
                totalCriteriaSum += Number(tr.children[7].textContent);
                coSum += Number(tr.children[8].textContent);
                khongSum += Number(tr.children[9].textContent);
                chuaSum += Number(tr.children[10].textContent);
            });

            // Th√™m d√≤ng t·ªïng c·ªông
            const footerRow = [
                'T·ªîNG C·ªòNG',
                '', '', '', '', '', '',
                totalCriteriaSum,
                coSum,
                khongSum,
                chuaSum
            ];
            sheet.addRow(footerRow);

            // ƒê·ªãnh d·∫°ng d√≤ng t·ªïng c·ªông
            const lastRow = sheet.lastRow;
            lastRow.font = { bold: true };
            lastRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFFFE0B2' } // M√†u cam nh·∫°t
            };

            // G·ªôp √¥ cho c·ªôt "T·ªîNG C·ªòNG"
            sheet.mergeCells(`A${lastRow.number}:G${lastRow.number}`);


            // üñº Ch√®n bi·ªÉu ƒë·ªì
            // üñºÔ∏è Ch√®n bi·ªÉu ƒë·ªì c·ªôt (to h∆°n 0.5x)
            {
                const chartBarDataUrl = canvas1.toDataURL("image/png");
                const chartBase64 = chartBarDataUrl.split(',')[1];
                const chartBinary = atob(chartBase64);
                const chartBytes = new Uint8Array(chartBinary.length);
                for (let i = 0; i < chartBinary.length; i++) chartBytes[i] = chartBinary.charCodeAt(i);

                const chartImgId = workbook.addImage({
                    buffer: chartBytes,
                    extension: 'png'
                });

                const chartStartRow = sheet.rowCount + 2;
                sheet.addImage(chartImgId, {
                    tl: { col: 1, row: chartStartRow },
                    br: { col: 8, row: chartStartRow + 20 } // k√©o ngang h∆°n (t·ª´ col 1 ‚Üí 8)
                });

                // üè∑Ô∏è Th√™m t√™n b√™n d∆∞·ªõi ·∫£nh v√† cƒÉn gi·ªØa
                const labelRow = sheet.getRow(chartStartRow + 21);
                labelRow.getCell(1).value = "Bi·ªÉu ƒë·ªì ƒë√°nh gi√° theo t·ª´ng chi nh√°nh trong khu v·ª±c";
                sheet.mergeCells(`A${chartStartRow + 21}:H${chartStartRow + 21}`); // ƒë·ªìng nh·∫•t d√≤ng
                labelRow.font = { bold: true, size: 26 };
                labelRow.alignment = { horizontal: "center" };
                labelRow.commit();

                // Ch·ªâ c·∫ßn t·∫°o kho·∫£ng tr·ªëng m·ªôt l·∫ßn sau ·∫£nh + t√™n
                for (let i = 0; i < 4; i++) sheet.addRow([]);
            }


            let rowOffset = sheet.rowCount + 2;
            let colOffset = 1;
            let chartPerRow = 3;

            for (let i = 0; i < pieCanvases.length; i++) {
                const canvas = pieCanvases[i];
                const chartName = canvas.parentElement.querySelector('div')?.textContent || `Danh m·ª•c ${i + 1}`;

                // üìå Convert canvas to image buffer
                const dataUrl = canvas.toDataURL("image/png");
                const base64 = dataUrl.split(',')[1];
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let j = 0; j < binary.length; j++) bytes[j] = binary.charCodeAt(j);

                const imageId = workbook.addImage({
                    buffer: bytes,
                    extension: 'png'
                });

                // üñºÔ∏è Ch√®n bi·ªÉu ƒë·ªì tr√≤n
                sheet.addImage(imageId, {
                    tl: { col: colOffset, row: rowOffset },
                    ext: { width: 240, height: 240 }
                });

                // üìã T·∫°o b·∫£ng l·ªói chi ti·∫øt b√™n ph·∫£i bi·ªÉu ƒë·ªì
                const tableStartCol = colOffset + 5;
                const tableStartRow = rowOffset;
                const headers = ["STT", "L·ªói chi ti·∫øt", "S·ªë l·∫ßn l·ªói"];

                const headerRow = sheet.getRow(tableStartRow);
                headers.forEach((text, idx) => {
                    const cell = headerRow.getCell(tableStartCol + idx);
                    cell.value = text;
                    cell.font = { bold: true };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFD9E1F2' }
                    };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });

                headerRow.commit();

                const cat = chartName;
                const errors = errorSummary[cat] || {};
                const sortedErrors = Object.entries(errors).sort((a, b) => b[1] - a[1]);

                for (let j = 0; j < sortedErrors.length; j++) {
                    const [desc, count] = sortedErrors[j];
                    const row = sheet.getRow(tableStartRow + 1 + j);

                    row.getCell(tableStartCol).value = j + 1;
                    row.getCell(tableStartCol + 1).value = desc;
                    row.getCell(tableStartCol + 2).value = count;

                    // CƒÉn gi·ªØa c·ªôt STT
                    sheet.getColumn(tableStartCol).alignment = { horizontal: 'center' };

                    // CƒÉn gi·ªØa c·ªôt "S·ªë l·∫ßn l·ªói"
                    sheet.getColumn(tableStartCol + 2).alignment = { horizontal: 'center' };


                    for (let k = 0; k < 3; k++) {
                        row.getCell(tableStartCol + k).border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    }

                    row.commit();
                }

                // üßæ Ghi t√™n danh m·ª•c b√™n d∆∞·ªõi ·∫£nh
                const labelRow = sheet.getRow(rowOffset + 13);
                labelRow.getCell(colOffset + 1).value = chartName;
                sheet.mergeCells(labelRow.number, colOffset + 1, labelRow.number, colOffset + 3);
                labelRow.font = { bold: false };
                // labelRow.alignment = { horizontal: "center" };
                labelRow.commit();

                // üìè T√≠nh h√†ng ti·∫øp theo
                rowOffset += Math.max(15, sortedErrors.length + 2);
                colOffset = 1;
            }

            // ‚úÖ Ch√®n ch√∫ th√≠ch d∆∞·ªõi c√πng b·∫£ng Excel
            let legendStartRow = sheet.rowCount + 2;
            const legendItems = [
                { label: "C√ì", color: "00B050" },            // Xanh l√°
                { label: "KH√îNG", color: "FF0000" },         // ƒê·ªè
                { label: "CH∆ØA KI·ªÇM TRA", color: "A5A5A5" }  // X√°m
            ];

            sheet.addRow([]); // kho·∫£ng tr·ªëng

            legendItems.forEach((item, i) => {
                const row = sheet.getRow(legendStartRow + i);
                row.getCell(2).value = item.label;
                row.getCell(2).font = { bold: true };

                row.getCell(1).fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: `FF${item.color}` }
                };

                row.height = 18;
                row.commit();
            });


            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), fileName);
        });


        summaryFilesInput.addEventListener('change', () => {
            const files = Array.from(summaryFilesInput.files); // 


            files.forEach(async (file) => {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const parts = file.name.replace(".xlsx", "").split("-");
                const area = parts[2] || "N/A"; // 
                const branch = parts[3] || "N/A";

                // if (parts.length != 7) {
                //     return showError("L·ªói ƒë·ªãnh d·∫°ng t√™n file", `File <strong>${file.name}</strong> kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.`);
                // }

                if (!selectedArea) {
                    selectedArea = area;  // khu v·ª±c ƒë·∫ßu ti√™n
                }

                if (area !== selectedArea) {
                    showError("Kh√¥ng ƒë√∫ng khu v·ª±c", "T·∫•t c·∫£ c√°c file ph·∫£i thu·ªôc c√πng 1 khu v·ª±c.");

                    return;
                }

                if (!selectedFiles.has(file.name)) {
                    selectedFiles.set(file.name, file);
                }

                renderFileList();
            });

            summaryFilesInput.value = '';
            renderFileList();
        });

        function renderFileList() {
            fileListDisplay.innerHTML = '';

            // üü¢ C·∫≠p nh·∫≠t l·∫°i khu v·ª±c d·ª±a tr√™n file ƒë·∫ßu ti√™n c√≤n l·∫°i
            const remainingFiles = Array.from(selectedFiles.values());
            if (remainingFiles.length > 0) {
                const parts = remainingFiles[0].name.replace(".xlsx", "").split("-");
                selectedArea = parts[2] || null;
            } else {
                selectedArea = null;
            }

            selectedFiles.forEach((file, name) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 px-3 py-1 rounded';
                const span = document.createElement('span');
                span.textContent = name;
                const btn = document.createElement('button');
                btn.innerHTML = '<i class="fas fa-times text-red-500"></i>';
                btn.className = 'ml-2 hover:text-red-700';
                btn.onclick = () => {
                    selectedFiles.delete(name);
                    renderFileList(); // üü¢ s·∫Ω t·ª± c·∫≠p nh·∫≠t selectedArea
                };
                div.appendChild(span);
                div.appendChild(btn);
                fileListDisplay.appendChild(div);
            });
        }


        function getSummaryFromSheet(sheet, fileName) {
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const parts = fileName.replace(".xlsx", "").split("-");
            const supervisor = parts[0] || "N/A";
            const email = sheet['B4']?.v?.toString().trim() || "N/A";
            const area = parts[2] || "N/A";         // üÜï Khu v·ª±c
            const branch = parts[3] || "N/A";       // üÜï Chi nh√°nh
            // const date = parts.slice(4).join("-");  // üÜï Ng√†y ƒë√°nh gi√° ƒë√∫ng chu·∫©n yyyy-mm-dd
            const date = sheet['B6']?.v?.toString().trim() || "N/A";  // üÜï L·∫•y t·ª´ √¥ B6 thay v√¨ t√™n file

            const fullName = rows[2]?.[1] || "N/A";

            const resultCounts = { "C√ì": 0, "KH√îNG": 0, "CH∆ØA KI·ªÇM TRA": 0 };
            const categoryStats = {};
            const errorDetails = {};
            let totalCriteria = 0; // TH√äM D√íNG N√ÄY
            for (let i = 7; i < rows.length; i++) {
                const cat = rows[i]?.[1];
                const detail = rows[i]?.[2]?.toString().trim() || "";
                const result = rows[i]?.[5]?.toString().trim();

                if (!cat || !resultCounts.hasOwnProperty(result)) continue;
                totalCriteria++;
                resultCounts[result]++;
                if (!categoryStats[cat]) categoryStats[cat] = { "C√ì": 0, "KH√îNG": 0, "CH∆ØA KI·ªÇM TRA": 0 };
                categoryStats[cat][result]++;

                if (result === "KH√îNG") {
                    if (!errorDetails[cat]) errorDetails[cat] = {};
                    if (!errorDetails[cat][detail]) errorDetails[cat][detail] = 0;
                    errorDetails[cat][detail]++;
                }
            }

            return {
                supervisor,
                email,
                fullName,
                area,     // üÜï Tr·∫£ v·ªÅ khu v·ª±c n·∫øu b·∫°n mu·ªën d√πng sau
                branch,
                date,
                ...resultCounts,
                categoryStats,
                errorDetails,
                totalCriteria
            };
        }




        document.getElementById('generateSummaryBtn').addEventListener('click', async () => {
            errorSummary = {};           // üßº Reset l·ªói t·ªïng h·ª£p
            summaryTableBody.innerHTML = ''; // üßº Clear b·∫£ng t·ªïng h·ª£p c≈© n·∫øu c√≥
            document.getElementById("branchReportBody").innerHTML = "";
            document.getElementById("pieChartContainer").innerHTML = "";
            document.getElementById("chartContainer").classList.add("hidden");
            document.getElementById("pieChartContainer").classList.add("hidden");
            document.getElementById("summaryTableContainer").classList.add("hidden");
            document.getElementById("branchReportContainer").classList.add("hidden");

            const files = Array.from(selectedFiles.values());
            if (!files.length) return showError('Ch∆∞a ch·ªçn file.');

            const summaryMap = new Map(); // key = email|branch
            const categoryTotals = {};

            const TOTAL_CRITERIA = 115;

            for (const file of files) {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const { supervisor, fullName, email, area, branch, date, C√ì, KH√îNG, "CH∆ØA KI·ªÇM TRA": CHUA, categoryStats, errorDetails, totalCriteria } = getSummaryFromSheet(sheet, file.name);

                const key = `${fullName}|${area}`;

                if (!summaryMap.has(key)) {
                    summaryMap.set(key, { fullName, email, branch, C√ì: 0, KH√îNG: 0, CHUA: 0, count: 0 });
                }

                const r = summaryMap.get(key);

                r.C√ì += C√ì;

                r.KH√îNG += KH√îNG;
                r.CHUA += CHUA;
                r.count++;
                r.totalCriteria += totalCriteria;
                for (const [cat, values] of Object.entries(categoryStats)) {
                    if (!categoryTotals[cat]) categoryTotals[cat] = { "C√ì": 0, "KH√îNG": 0, "CH∆ØA KI·ªÇM TRA": 0 };
                    categoryTotals[cat]["C√ì"] += values["C√ì"];
                    categoryTotals[cat]["KH√îNG"] += values["KH√îNG"];
                    categoryTotals[cat]["CH∆ØA KI·ªÇM TRA"] += values["CH∆ØA KI·ªÇM TRA"];
                }
                // üü¶ G·ªôp l·ªói chi ti·∫øt
                for (const [cat, details] of Object.entries(errorDetails)) {
                    if (!errorSummary[cat]) errorSummary[cat] = {};
                    for (const [desc, count] of Object.entries(details)) {
                        if (!errorSummary[cat][desc]) errorSummary[cat][desc] = 0;
                        errorSummary[cat][desc] += count;
                    }
                }

            }

            // Chu·∫©n b·ªã d·ªØ li·ªáu bi·ªÉu ƒë·ªì ph·∫ßn trƒÉm
            const branchStats = {}; // gom theo chi nh√°nh

            for (const { branch, C√ì, KH√îNG, CHUA, count } of summaryMap.values()) {
                if (!branchStats[branch]) {
                    branchStats[branch] = { C√ì: 0, KH√îNG: 0, CHUA: 0, count: 0 };
                }
                branchStats[branch].C√ì += C√ì;
                branchStats[branch].KH√îNG += KH√îNG;
                branchStats[branch].CHUA += CHUA;
                branchStats[branch].count += count;
            }

            const labels = [];
            const dataYes = [];
            const dataNo = [];
            const dataNA = [];

            for (const [branch, stats] of Object.entries(branchStats)) {
                const total = stats.C√ì + stats.KH√îNG + stats.CHUA;
                const safeTotal = total === 0 ? 1 : total;

                labels.push(branch);
                dataYes.push(parseFloat(((stats.C√ì / safeTotal) * 100).toFixed(2)));
                dataNo.push(parseFloat(((stats.KH√îNG / safeTotal) * 100).toFixed(2)));
                dataNA.push(parseFloat(((stats.CHUA / safeTotal) * 100).toFixed(2)));
            }




            const ctx = document.getElementById('branchBarChart').getContext('2d');
            chartContainer.classList.remove('hidden');

            // üßº G·ª° bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (branchChart) {
                branchChart.destroy();
            }

            branchChart = new Chart(ctx, {

                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: '% C√ì', data: dataYes, backgroundColor: 'rgba(0, 176, 80, 0.6)' },
                        { label: '% KH√îNG', data: dataNo, backgroundColor: 'rgba(255, 0, 0, 0.6)' },
                        { label: '% CH∆ØA KI·ªÇM TRA', data: dataNA, backgroundColor: 'rgba(165, 165, 165, 0.6)' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#000',
                            font: { weight: 'bold', size: 16 },
                            formatter: function (value) {
                                return value.toFixed(2) + '%';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'T·ª∑ l·ªá (%)'
                            }
                        }
                    }
                },

                plugins: [ChartDataLabels] // üü¢ TH√äM D√íNG N√ÄY

            });

            // T·∫°o bi·ªÉu ƒë·ªì doughnut cho t·ª´ng danh m·ª•c
            const pieChartContainer = document.getElementById('pieChartContainer');
            pieChartContainer.innerHTML = ''; // clear c≈©
            pieChartContainer.classList.remove('hidden');

            // T·∫°o container grid ch·ª©a c√°c bi·ªÉu ƒë·ªì tr√≤n
            const pieContainer = document.createElement('div');
            pieContainer.className = 'flex flex-col gap-6 mt-6 items-center';

            pieChartContainer.appendChild(pieContainer);

            // T·∫°o bi·ªÉu ƒë·ªì tr√≤n t·ª´ng danh m·ª•c

            for (const [cat, vals] of Object.entries(categoryTotals)) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col lg:flex-row gap-4 items-start bg-white p-4 rounded shadow';

                // Bi·ªÉu ƒë·ªì tr√≤n
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'text-center';

                const canvas = document.createElement('canvas');
                canvas.className = 'w-[240px] h-[240px]';
                chartWrapper.appendChild(canvas);

                const title = document.createElement('div');
                title.className = 'font-semibold text-sm text-gray-800 mt-2';
                title.textContent = cat;
                chartWrapper.appendChild(title);

                wrapper.appendChild(chartWrapper);

                // B·∫£ng chi ti·∫øt l·ªói
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'overflow-auto w-[800px] min-w-[800px] max-w-[800px] h-[240px]';



                const table = document.createElement('table');
                table.className = 'w-full text-xs text-left text-gray-700 border rounded';

                table.innerHTML = `
<thead class="bg-gray-200 text-gray-900 sticky top-0 z-10">

    <tr>
        <th class="px-2 py-1 border w-[10%] text-center">STT</th>
        <th class="px-2 py-1 border w-[70%]">L·ªói chi ti·∫øt</th>
        <th class="px-2 py-1 border w-[20%] text-center">S·ªë l·∫ßn l·ªói</th>
    </tr>
</thead>
<tbody></tbody>
`;


                const tbody = table.querySelector('tbody');
                const errorList = errorSummary[cat] || {};
                const sortedErrors = Object.entries(errorList).sort((a, b) => b[1] - a[1]);

                sortedErrors.forEach(([desc, count], index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td class="px-2 py-1 border text-center">${index + 1}</td>
            <td class="px-2 py-1 border">${desc}</td>
            <td class="px-2 py-1 border text-center">${count}</td>
        `;
                    tbody.appendChild(row);
                });

                tableWrapper.appendChild(table);
                wrapper.appendChild(tableWrapper);

                pieContainer.appendChild(wrapper);

                // V·∫Ω bi·ªÉu ƒë·ªì tr√≤n
                new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: ['C√ì', 'KH√îNG', 'CH∆ØA KI·ªÇM TRA'],
                        datasets: [{
                            data: [vals["C√ì"], vals["KH√îNG"], vals["CH∆ØA KI·ªÇM TRA"]],
                            backgroundColor: ['#00B050', '#FF0000', '#A5A5A5']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 26
                                },
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return value > 0
                                        ? `${((value / total) * 100).toFixed(1)}%`
                                        : '';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // ‚úÖ T·∫°o ch√∫ th√≠ch chung b√™n d∆∞·ªõi
            const legendWrapper = document.createElement('div');
            legendWrapper.className = 'flex justify-center items-center gap-6 mt-6 flex-wrap text-sm text-gray-800 font-medium';

            const legends = [
                { color: '#00B050', label: 'C√ì' },
                { color: '#FF0000', label: 'KH√îNG' },
                { color: '#A5A5A5', label: 'CH∆ØA KI·ªÇM TRA' }
            ];

            legends.forEach(({ color, label }) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-2';

                const box = document.createElement('div');
                box.className = 'w-4 h-4 rounded';
                box.style.backgroundColor = color;

                const text = document.createElement('span');
                text.textContent = label;

                item.appendChild(box);
                item.appendChild(text);
                legendWrapper.appendChild(item);
            });

            pieChartContainer.appendChild(legendWrapper);

            // Hi·ªÉn th·ªã b·∫£ng b√°o c√°o chi nh√°nh
            const branchReportContainer = document.getElementById('branchReportContainer');
            const branchReportBody = document.getElementById('branchReportBody');
            branchReportBody.innerHTML = '';
            branchReportContainer.classList.remove('hidden');

            let index = 1; // Kh·ªüi t·∫°o STT
            for (const file of files) {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const { supervisor, fullName, email, area, branch, date, C√ì, KH√îNG, "CH∆ØA KI·ªÇM TRA": CHUA, totalCriteria } = getSummaryFromSheet(sheet, file.name);

                const row = document.createElement('tr');
                row.className = 'border-b';

                row.innerHTML = `
        <td class="py-2 px-4 text-center">${index}</td>
        <td class="py-2 px-4">${supervisor}</td>
        <td class="py-2 px-4">${fullName}</td> 
        <td class="py-2 px-4">${email}</td>
        <td class="py-2 px-4">${area}</td>  
        <td class="py-2 px-4">${branch}</td>
        <td class="py-2 px-4">${date}</td>
        <td class="py-2 px-4 text-center">${totalCriteria}</td>
        <td class="py-2 px-4 text-center">${C√ì}</td>
        <td class="py-2 px-4 text-center">${KH√îNG}</td>
        <td class="py-2 px-4 text-center">${CHUA}</td>
    `;

                branchReportBody.appendChild(row);
                index++;
            }

            updateBranchReportFooter();

        });
        // Th√™m h√†m t√≠nh t·ªïng v√† hi·ªÉn th·ªã footer
        function updateBranchReportFooter() {
            const footer = document.getElementById('branchReportFooter');
            footer.innerHTML = '';
            footer.classList.remove('hidden');

            let totalCriteriaSum = 0, coSum = 0, khongSum = 0, chuaSum = 0;

            document.querySelectorAll("#branchReportBody tr").forEach(tr => {
                totalCriteriaSum += Number(tr.children[7].textContent);
                coSum += Number(tr.children[8].textContent);
                khongSum += Number(tr.children[9].textContent);
                chuaSum += Number(tr.children[10].textContent);
            });

            const footerRow = document.createElement('tr');
            footerRow.innerHTML = `
        <td class="py-2 px-4 text-center" colspan="7">T·ªîNG C·ªòNG</td>
        <td class="py-2 px-4 text-center">${totalCriteriaSum}</td>
        <td class="py-2 px-4 text-center">${coSum}</td>
        <td class="py-2 px-4 text-center">${khongSum}</td>
        <td class="py-2 px-4 text-center">${chuaSum}</td>
    `;
            footer.appendChild(footerRow);
        }
    </script>
</body>

</html>