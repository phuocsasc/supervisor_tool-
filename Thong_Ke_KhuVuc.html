<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê dữ liệu Khu Vực</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="logoFPT.png" type="image/x-icon">

    <style>
        .active-menu {
            font-weight: 600;
            background: linear-gradient(to right, rgb(255, 255, 255), rgba(189, 230, 237, 0.805));
            color: black !important;

            border-radius: 8px;
            /* tùy chọn nếu bạn muốn làm mềm góc */
            transition: background 0.3s ease;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }

        .menu-item {
            color: white;
            font-weight: 600;
        }

        .menu-item:hover {
            font-weight: 600;
            background: linear-gradient(to right, rgb(255, 255, 255), rgba(189, 230, 237, 0.805));
            color: black !important;

            border-radius: 8px;
            /* tùy chọn nếu bạn muốn làm mềm góc */
            transition: background 0.3s ease;
        }

        #sidebar {
            transition: all 0.3s;
            box-shadow: rgba(0, 0, 0, 0.24) 5px 8px 18px;


        }

        .admin-bg {
            background-image: url(background_nav.jpg);

            background-size: cover;
            /* co giãn ảnh để phủ hết phần tử */
            background-repeat: no-repeat;
            /* không lặp ảnh */
            background-position: center;
            /* căn giữa ảnh nền */
        }

        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                position: absolute;
                z-index: 50;
                height: 100vh;
            }

            #sidebar.open {
                transform: translateX(0);
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }

            .overlay.open {
                display: block;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-orange-200 to-white">
    <div class="flex h-screen overflow-hidden">
        <!-- Mobile menu button -->
        <div class="md:hidden fixed top-4 left-4 z-50">
            <button id="menuToggle" class="p-2 rounded-md bg-orange-500 text-white">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Overlay for mobile -->
        <div id="overlay" class="overlay"></div>

        <!-- Sidebar -->
        <div id="sidebar"
            class="sidebar admin-bg text-gray-800 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 shadow-lg">
            <!-- Logo -->
            <div class="flex items-center space-x-2 px-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-8  flex items-center justify-center">
                            <img src="logoFPT.png" alt="">
                        </div>
                    </div>
                </div>
                <span class="text-xl font-bold text-white">QUẢN TRỊ VIÊN</span>
            </div>

            <!-- Navigation -->
            <nav>
                <div class="space-y-2">
                    <a href="admin.html" class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        Trang Chủ
                    </a>
                    <a href="Truy_xuat_data.html" class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-layer-group mr-3"></i>
                        Gom Nhóm Dữ Liệu
                    </a>
                    <a href="Thong_Ke_NhanVien.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-users mr-3"></i>
                        Thống Kê Nhân Viên
                    </a>
                    <a href="Thong_Ke_NguoiGiamSat.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-user-tie mr-3"></i>
                        Thống Kê Người Giám Sát
                    </a>
                    <a href="Thong_Ke_ChiNhanh.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-code-branch mr-4"></i>
                        Thống Kê Chi Nhánh
                    </a>
                    <a href="Thong_Ke_KhuVuc.html"
                        class="active-menu menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-map-marked-alt mr-4"></i>
                        Thống Kê Khu Vực
                    </a>
                    <a href="Thong_Ke_ToanQuoc.html"
                        class="menu-item block py-2.5 px-2 rounded transition duration-200 ">
                        <i class="fas fa-globe-americas mr-4"></i>
                        Thống Kê Toàn Quốc
                    </a>

                </div>
            </nav>

            <!-- Logout button at bottom -->
            <div class="absolute bottom-0 left-0 right-0 p-4">
                <a href="index.html"
                    class="block py-2.5 px-4 rounded transition duration-200 bg-gradient-to-r from-pink-500 to-red-500 text-white hover:from-pink-600 hover:to-red-600 shadow-md hover:shadow-lg">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    Thoát
                </a>
            </div>
        </div>


        <!-- Main content -->
        <main class="flex-1 overflow-y-auto p-2">
            <div class="bg-white rounded-lg shadow p-6">
                <!-- Nội dung của từng tool -->
                <div class="max-w-8xl mx-auto px-2">
                    <div class="bg-white rounded-lg shadow p-4 ">
                        <h1 class="text-3xl font-bold text-orange-600 mb-2">
                            <i class="fas fa-map-marked-alt mr-3"></i>
                            THỐNG KÊ DỮ LIỆU THEO KHU VỰC
                        </h1>
                        <div class="mb-6">
                            <label class="block text-gray-600 text-sm mb-5">
                                Tải lên các file Excel dữ liệu cho 1 Khu Vực</label>
                            <input type="file" id="summaryFiles" accept=".xlsx" multiple class="hidden">
                            <button id="chooseSummaryFilesBtn"
                                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded btn-hover">
                                <i class="fas fa-folder-open mr-1"></i> Chọn File
                            </button>
                            <div id="fileListDisplay"
                                class="mt-2 space-y-1 text-sm text-gray-700 max-h-[160px] overflow-y-auto pr-1">
                            </div>

                            <p class="text-xs text-gray-500 mt-1">Chỉ hỗ trợ file Excel .xlsx đúng định
                                dạng mà người giám sát cung cấp</p>
                        </div>
                        <!-- Alert lỗi -->
                        <div id="errorAlert"
                            class="hidden fade-in bg-red-50 border-l-4 border-red-500 p-4 my-4 rounded-r-lg">
                            <div class="flex">
                                <div class="flex-shrink-0 pt-0.5">
                                    <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800" id="errorTitle">Có
                                        lỗi xảy ra</h3>
                                    <div class="mt-2 text-sm text-red-700" id="errorMessage">
                                        <!-- Nội dung lỗi -->
                                    </div>
                                </div>
                                <button id="closeErrorBtn"
                                    class="ml-auto -mx-1.5 -my-1.5 bg-red-50 rounded-lg p-1.5 inline-flex h-8 w-8 text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>



                        <button id="generateSummaryBtn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 mt-3 rounded btn-hover">
                            <i class="fas fa-chart-pie mr-1"></i> Xử lý dữ liệu
                        </button>
                        <button id="exportExcelBtn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-2 mt-3 rounded btn-hover">
                            <i class="fas fa-file-export mr-1"></i> Xuất File Excel
                        </button>
                        <button id="resetPageBtn"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 mt-3 rounded btn-hover">
                            <i class="fas fa-rotate-left mr-1"></i> Làm mới
                        </button>


                    </div>
                    <div id="branchReportContainer" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Báo cáo tình hình Khu Vực
                        </h3>
                        <div class="overflow-x-auto max-h-[520px] overflow-y-auto rounded border border-gray-300">
                            <table class="min-w-full bg-white rounded shadow text-sm">
                                <thead class="bg-orange-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="py-2 px-4 bg-orange-600">STT</th>
                                        <th class="py-2 px-4 bg-orange-600">Email người giám sát</th>
                                        <th class="py-2 px-4 bg-orange-600">Tên nhân viên</th>
                                        <th class="py-2 px-4 bg-orange-600">Email Nhân Viên</th>
                                        <th class="py-2 px-4 bg-orange-600">Khu Vực</th>
                                        <th class="py-2 px-4 bg-orange-600">Chi nhánh</th>
                                        <th class="py-2 px-4 bg-orange-600">Ngày đánh giá</th>
                                        <th class="py-2 px-4 bg-orange-600">Tổng tiêu chí</th>
                                        <th class="py-2 px-4 bg-orange-600">CÓ</th>
                                        <th class="py-2 px-4 bg-orange-600">KHÔNG</th>
                                        <th class="py-2 px-4 bg-orange-600">CHƯA KIỂM TRA</th>
                                    </tr>
                                </thead>
                                <tbody id="branchReportBody"></tbody>
                                <tfoot id="branchReportFooter" class="hidden bg-orange-100 font-semibold text-gray-900">
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div id="chartContainer" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Biểu đồ đánh giá theo từng chi nhánh trong khu vực
                        </h3>
                        <canvas id="branchBarChart" class="bg-white p-4 rounded shadow"></canvas>
                    </div>

                    <div id="summaryTableContainer" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Tổng hợp đánh giá theo danh mục
                            1</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded shadow text-sm">
                                <thead>
                                    <tr class="bg-orange-700 text-white">
                                        <th class="py-2 px-4 text-left">Danh mục 1</th>
                                        <th class="py-2 px-4 text-center">CÓ (đạt yêu cầu)</th>
                                        <th class="py-2 px-4 text-center">KHÔNG (chưa đạt yêu cầu)
                                        </th>
                                        <th class="py-2 px-4 text-center">CHƯA KIỂM TRA</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Biểu đồ tròn theo từng danh mục -->
                    <div id="pieChartContainer" class="mt-8 hidden"></div>
                </div>


            </div>

        </main>

    </div>



    <script>
        let branchChart = null;

        const chooseSummaryFilesBtn = document.getElementById('chooseSummaryFilesBtn');
        const summaryFilesInput = document.getElementById('summaryFiles');
        const fileListDisplay = document.getElementById('fileListDisplay');
        const chartContainer = document.getElementById('chartContainer');
        const summaryTableContainer = document.getElementById('summaryTableContainer');
        const summaryTableBody = document.getElementById('summaryTableBody');

        const errorAlert = document.getElementById('errorAlert');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const closeErrorBtn = document.getElementById('closeErrorBtn');
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        });
        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('open');
        });

        document.querySelectorAll('#sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('overlay').classList.remove('open');
            });
        });
        function showError(title, message) {
            errorTitle.textContent = title;
            errorMessage.innerHTML = message;
            errorAlert.classList.remove('hidden');
            errorAlert.classList.add('fade-in');

            setTimeout(() => {
                errorAlert.classList.add('hidden');
            }, 5000);
        }

        closeErrorBtn?.addEventListener('click', () => {
            errorAlert.classList.add('hidden');
        });

        let selectedFiles = new Map();
        let selectedArea = null;
        let errorSummary = {}; // 🟦 Khai báo toàn cục

        chooseSummaryFilesBtn.addEventListener('click', () => summaryFilesInput.click());
        document.getElementById("resetPageBtn").addEventListener("click", () => {
            if (confirm("Bạn có chắc chắn muốn làm mới toàn bộ trang?")) {
                location.reload();
            }
        });

        document.getElementById("exportExcelBtn").addEventListener("click", async () => {
            const files = Array.from(selectedFiles.values());
            if (!files.length) return showError('Chưa chọn file.');
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet("Thong Ke Chi Nhan");

            const canvas1 = document.getElementById("branchBarChart");
            const pieCanvases = document.querySelectorAll("#pieChartContainer canvas");

            // ✅ Định nghĩa HÀM trước khi sử dụng
            const addImageFromCanvas = async (canvas, rowOffset) => {
                const dataUrl = canvas.toDataURL("image/png");
                const base64 = dataUrl.split(',')[1];
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

                const imageId = workbook.addImage({
                    buffer: bytes,
                    extension: 'png'
                });

                sheet.addImage(imageId, {
                    tl: { col: colOffset, row: rowOffset },
                    ext: { width: 320, height: 240 }  // ✅ cố định kích thước pixel
                });


                // Tạo khoảng trống sau ảnh
                for (let i = 0; i < 14; i++) sheet.addRow([]);
            };

            // Lấy tên chi nhánh từ dòng đầu tiên có sẵn trong bảng
            const firstBranchRow = document.querySelector("#branchReportBody tr");
            const branchNameRaw = firstBranchRow?.querySelector("td:nth-child(5)")?.textContent || "ChiNhanh";
            const branchName = branchNameRaw.replace(/[^a-zA-ZÀ-ỹ0-9 ]/g, "");


            // Lấy ngày hiện tại định dạng dd-MM-yyyy
            // const today = new Date();
            // const dateStr = today.toLocaleDateString('vi-VN').replaceAll('/', '-');
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');

            // Gộp tên file
            const fileName = `ThongKeKhuVuc_${branchName}_${yyyy}-${mm}-${dd}.xlsx`;
            const titleRow = sheet.addRow([branchName]);
            sheet.mergeCells(`A1:K1`);
            titleRow.font = { bold: true, size: 14, color: { argb: 'FF1F4E78' } };
            titleRow.alignment = { horizontal: 'center' };

            // 🟦 Header bảng
            const header = ["STT", "Email Người Giám Sát", "Tên nhân viên", "Email", "Khu Vực", "Chi nhánh", "Ngày đánh giá", "Tổng tiêu chí", "CÓ", "KHÔNG", "CHƯA KIỂM TRA"]
            const headerRow = sheet.addRow(header);
            // Tự động điều chỉnh độ rộng cho từng cột
            sheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 0;
                    maxLength = Math.max(maxLength, cellLength);
                });
                column.width = maxLength + 2; // cộng thêm padding
            });

            headerRow.font = { bold: true, color: { argb: "FFFFFFFF" } };
            const headerFill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF0070C0' }
            };

            for (let i = 1; i <= header.length; i++) {
                const cell = headerRow.getCell(i);
                cell.fill = headerFill;
            }

            headerRow.alignment = { horizontal: 'center' };
            //Dữ liệu bảng
            let index = 1;
            document.querySelectorAll("#branchReportBody tr").forEach(tr => {
                const tds = tr.querySelectorAll("td");
                const rowData = [
                    index++,
                    `${tds[1].textContent.trim()}`, // Email người giám sát đã hiển thị đúng
                    tds[2].textContent.trim(), // Tên nhân viên
                    tds[3].textContent.trim(), // Email
                    tds[4].textContent.trim(), // khu vực
                    tds[5].textContent.trim(),// Chi nhánh
                    tds[6].textContent.trim(), // Ngày đánh giá
                    tds[7].textContent.trim(), // Tổng tiêu chí
                    tds[8].textContent.trim(), // CÓ
                    tds[9].textContent.trim(), // KHÔNG
                    tds[10].textContent.trim()  // CHƯA KIỂM TRA
                ];
                sheet.addRow(rowData);
                sheet.columns = [
                    { key: 'stt', width: 8 },
                    { key: 'emailGiamSat', width: 25 },
                    { key: 'tenNhanVien', width: 25 },
                    { key: 'emailNV', width: 25 },
                    { key: 'khuVuc', width: 15 },
                    { key: 'chiNhanh', width: 15 },
                    { key: 'ngayDanhGia', width: 15 },
                    { key: 'tongTieuChi', width: 15 },
                    { key: 'co', width: 15 },
                    { key: 'khong', width: 15 },
                    { key: 'chuaKT', width: 22 }
                ];
                // Căn giữa toàn bộ cột (từ A đến K = 11 cột)
                for (let i = 1; i <= 11; i++) {
                    sheet.getColumn(i).alignment = { horizontal: 'center', vertical: 'middle', wrapText: false };
                }
            });
            // Tính tổng các cột
            let totalCriteriaSum = 0, coSum = 0, khongSum = 0, chuaSum = 0;

            document.querySelectorAll("#branchReportBody tr").forEach(tr => {
                totalCriteriaSum += Number(tr.children[7].textContent);
                coSum += Number(tr.children[8].textContent);
                khongSum += Number(tr.children[9].textContent);
                chuaSum += Number(tr.children[10].textContent);
            });

            // Thêm dòng tổng cộng
            const footerRow = [
                'TỔNG CỘNG',
                '', '', '', '', '', '',
                totalCriteriaSum,
                coSum,
                khongSum,
                chuaSum
            ];
            sheet.addRow(footerRow);

            // Định dạng dòng tổng cộng
            const lastRow = sheet.lastRow;
            lastRow.font = { bold: true };
            lastRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFFFE0B2' } // Màu cam nhạt
            };

            // Gộp ô cho cột "TỔNG CỘNG"
            sheet.mergeCells(`A${lastRow.number}:G${lastRow.number}`);


            // 🖼 Chèn biểu đồ
            // 🖼️ Chèn biểu đồ cột (to hơn 0.5x)
            {
                const chartBarDataUrl = canvas1.toDataURL("image/png");
                const chartBase64 = chartBarDataUrl.split(',')[1];
                const chartBinary = atob(chartBase64);
                const chartBytes = new Uint8Array(chartBinary.length);
                for (let i = 0; i < chartBinary.length; i++) chartBytes[i] = chartBinary.charCodeAt(i);

                const chartImgId = workbook.addImage({
                    buffer: chartBytes,
                    extension: 'png'
                });

                const chartStartRow = sheet.rowCount + 2;
                sheet.addImage(chartImgId, {
                    tl: { col: 1, row: chartStartRow },
                    br: { col: 8, row: chartStartRow + 20 } // kéo ngang hơn (từ col 1 → 8)
                });

                // 🏷️ Thêm tên bên dưới ảnh và căn giữa
                const labelRow = sheet.getRow(chartStartRow + 21);
                labelRow.getCell(1).value = "Biểu đồ đánh giá theo từng chi nhánh trong khu vực";
                sheet.mergeCells(`A${chartStartRow + 21}:H${chartStartRow + 21}`); // đồng nhất dòng
                labelRow.font = { bold: true, size: 26 };
                labelRow.alignment = { horizontal: "center" };
                labelRow.commit();

                // Chỉ cần tạo khoảng trống một lần sau ảnh + tên
                for (let i = 0; i < 4; i++) sheet.addRow([]);
            }


            let rowOffset = sheet.rowCount + 2;
            let colOffset = 1;
            let chartPerRow = 3;

            for (let i = 0; i < pieCanvases.length; i++) {
                const canvas = pieCanvases[i];
                const chartName = canvas.parentElement.querySelector('div')?.textContent || `Danh mục ${i + 1}`;

                // 📌 Convert canvas to image buffer
                const dataUrl = canvas.toDataURL("image/png");
                const base64 = dataUrl.split(',')[1];
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let j = 0; j < binary.length; j++) bytes[j] = binary.charCodeAt(j);

                const imageId = workbook.addImage({
                    buffer: bytes,
                    extension: 'png'
                });

                // 🖼️ Chèn biểu đồ tròn
                sheet.addImage(imageId, {
                    tl: { col: colOffset, row: rowOffset },
                    ext: { width: 240, height: 240 }
                });

                // 📋 Tạo bảng lỗi chi tiết bên phải biểu đồ
                const tableStartCol = colOffset + 5;
                const tableStartRow = rowOffset;
                const headers = ["STT", "Lỗi chi tiết", "Số lần lỗi"];

                const headerRow = sheet.getRow(tableStartRow);
                headers.forEach((text, idx) => {
                    const cell = headerRow.getCell(tableStartCol + idx);
                    cell.value = text;
                    cell.font = { bold: true };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFD9E1F2' }
                    };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });

                headerRow.commit();

                const cat = chartName;
                const errors = errorSummary[cat] || {};
                const sortedErrors = Object.entries(errors).sort((a, b) => b[1] - a[1]);

                for (let j = 0; j < sortedErrors.length; j++) {
                    const [desc, count] = sortedErrors[j];
                    const row = sheet.getRow(tableStartRow + 1 + j);

                    row.getCell(tableStartCol).value = j + 1;
                    row.getCell(tableStartCol + 1).value = desc;
                    row.getCell(tableStartCol + 2).value = count;

                    // Căn giữa cột STT
                    sheet.getColumn(tableStartCol).alignment = { horizontal: 'center' };

                    // Căn giữa cột "Số lần lỗi"
                    sheet.getColumn(tableStartCol + 2).alignment = { horizontal: 'center' };


                    for (let k = 0; k < 3; k++) {
                        row.getCell(tableStartCol + k).border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    }

                    row.commit();
                }

                // 🧾 Ghi tên danh mục bên dưới ảnh
                const labelRow = sheet.getRow(rowOffset + 13);
                labelRow.getCell(colOffset + 1).value = chartName;
                sheet.mergeCells(labelRow.number, colOffset + 1, labelRow.number, colOffset + 3);
                labelRow.font = { bold: false };
                // labelRow.alignment = { horizontal: "center" };
                labelRow.commit();

                // 📏 Tính hàng tiếp theo
                rowOffset += Math.max(15, sortedErrors.length + 2);
                colOffset = 1;
            }

            // ✅ Chèn chú thích dưới cùng bảng Excel
            let legendStartRow = sheet.rowCount + 2;
            const legendItems = [
                { label: "CÓ", color: "00B050" },            // Xanh lá
                { label: "KHÔNG", color: "FF0000" },         // Đỏ
                { label: "CHƯA KIỂM TRA", color: "A5A5A5" }  // Xám
            ];

            sheet.addRow([]); // khoảng trống

            legendItems.forEach((item, i) => {
                const row = sheet.getRow(legendStartRow + i);
                row.getCell(2).value = item.label;
                row.getCell(2).font = { bold: true };

                row.getCell(1).fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: `FF${item.color}` }
                };

                row.height = 18;
                row.commit();
            });


            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), fileName);
        });


        summaryFilesInput.addEventListener('change', () => {
            const files = Array.from(summaryFilesInput.files); // 


            files.forEach(async (file) => {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const parts = file.name.replace(".xlsx", "").split("-");
                const area = parts[2] || "N/A"; // 
                const branch = parts[3] || "N/A";

                // if (parts.length != 7) {
                //     return showError("Lỗi định dạng tên file", `File <strong>${file.name}</strong> không đúng định dạng.`);
                // }

                if (!selectedArea) {
                    selectedArea = area;  // khu vực đầu tiên
                }

                if (area !== selectedArea) {
                    showError("Không đúng khu vực", "Tất cả các file phải thuộc cùng 1 khu vực.");

                    return;
                }

                if (!selectedFiles.has(file.name)) {
                    selectedFiles.set(file.name, file);
                }

                renderFileList();
            });

            summaryFilesInput.value = '';
            renderFileList();
        });

        function renderFileList() {
            fileListDisplay.innerHTML = '';

            // 🟢 Cập nhật lại khu vực dựa trên file đầu tiên còn lại
            const remainingFiles = Array.from(selectedFiles.values());
            if (remainingFiles.length > 0) {
                const parts = remainingFiles[0].name.replace(".xlsx", "").split("-");
                selectedArea = parts[2] || null;
            } else {
                selectedArea = null;
            }

            selectedFiles.forEach((file, name) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 px-3 py-1 rounded';
                const span = document.createElement('span');
                span.textContent = name;
                const btn = document.createElement('button');
                btn.innerHTML = '<i class="fas fa-times text-red-500"></i>';
                btn.className = 'ml-2 hover:text-red-700';
                btn.onclick = () => {
                    selectedFiles.delete(name);
                    renderFileList(); // 🟢 sẽ tự cập nhật selectedArea
                };
                div.appendChild(span);
                div.appendChild(btn);
                fileListDisplay.appendChild(div);
            });
        }


        function getSummaryFromSheet(sheet, fileName) {
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const parts = fileName.replace(".xlsx", "").split("-");
            const supervisor = parts[0] || "N/A";
            const email = sheet['B4']?.v?.toString().trim() || "N/A";
            const area = parts[2] || "N/A";         // 🆕 Khu vực
            const branch = parts[3] || "N/A";       // 🆕 Chi nhánh
            // const date = parts.slice(4).join("-");  // 🆕 Ngày đánh giá đúng chuẩn yyyy-mm-dd
            const date = sheet['B6']?.v?.toString().trim() || "N/A";  // 🆕 Lấy từ ô B6 thay vì tên file

            const fullName = rows[2]?.[1] || "N/A";

            const resultCounts = { "CÓ": 0, "KHÔNG": 0, "CHƯA KIỂM TRA": 0 };
            const categoryStats = {};
            const errorDetails = {};
            let totalCriteria = 0; // THÊM DÒNG NÀY
            for (let i = 7; i < rows.length; i++) {
                const cat = rows[i]?.[1];
                const detail = rows[i]?.[2]?.toString().trim() || "";
                const result = rows[i]?.[5]?.toString().trim();

                if (!cat || !resultCounts.hasOwnProperty(result)) continue;
                totalCriteria++;
                resultCounts[result]++;
                if (!categoryStats[cat]) categoryStats[cat] = { "CÓ": 0, "KHÔNG": 0, "CHƯA KIỂM TRA": 0 };
                categoryStats[cat][result]++;

                if (result === "KHÔNG") {
                    if (!errorDetails[cat]) errorDetails[cat] = {};
                    if (!errorDetails[cat][detail]) errorDetails[cat][detail] = 0;
                    errorDetails[cat][detail]++;
                }
            }

            return {
                supervisor,
                email,
                fullName,
                area,     // 🆕 Trả về khu vực nếu bạn muốn dùng sau
                branch,
                date,
                ...resultCounts,
                categoryStats,
                errorDetails,
                totalCriteria
            };
        }




        document.getElementById('generateSummaryBtn').addEventListener('click', async () => {
            errorSummary = {};           // 🧼 Reset lỗi tổng hợp
            summaryTableBody.innerHTML = ''; // 🧼 Clear bảng tổng hợp cũ nếu có
            document.getElementById("branchReportBody").innerHTML = "";
            document.getElementById("pieChartContainer").innerHTML = "";
            document.getElementById("chartContainer").classList.add("hidden");
            document.getElementById("pieChartContainer").classList.add("hidden");
            document.getElementById("summaryTableContainer").classList.add("hidden");
            document.getElementById("branchReportContainer").classList.add("hidden");

            const files = Array.from(selectedFiles.values());
            if (!files.length) return showError('Chưa chọn file.');

            const summaryMap = new Map(); // key = email|branch
            const categoryTotals = {};

            const TOTAL_CRITERIA = 115;

            for (const file of files) {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const { supervisor, fullName, email, area, branch, date, CÓ, KHÔNG, "CHƯA KIỂM TRA": CHUA, categoryStats, errorDetails, totalCriteria } = getSummaryFromSheet(sheet, file.name);

                const key = `${fullName}|${area}`;

                if (!summaryMap.has(key)) {
                    summaryMap.set(key, { fullName, email, branch, CÓ: 0, KHÔNG: 0, CHUA: 0, count: 0 });
                }

                const r = summaryMap.get(key);

                r.CÓ += CÓ;

                r.KHÔNG += KHÔNG;
                r.CHUA += CHUA;
                r.count++;
                r.totalCriteria += totalCriteria;
                for (const [cat, values] of Object.entries(categoryStats)) {
                    if (!categoryTotals[cat]) categoryTotals[cat] = { "CÓ": 0, "KHÔNG": 0, "CHƯA KIỂM TRA": 0 };
                    categoryTotals[cat]["CÓ"] += values["CÓ"];
                    categoryTotals[cat]["KHÔNG"] += values["KHÔNG"];
                    categoryTotals[cat]["CHƯA KIỂM TRA"] += values["CHƯA KIỂM TRA"];
                }
                // 🟦 Gộp lỗi chi tiết
                for (const [cat, details] of Object.entries(errorDetails)) {
                    if (!errorSummary[cat]) errorSummary[cat] = {};
                    for (const [desc, count] of Object.entries(details)) {
                        if (!errorSummary[cat][desc]) errorSummary[cat][desc] = 0;
                        errorSummary[cat][desc] += count;
                    }
                }

            }

            // Chuẩn bị dữ liệu biểu đồ phần trăm
            const branchStats = {}; // gom theo chi nhánh

            for (const { branch, CÓ, KHÔNG, CHUA, count } of summaryMap.values()) {
                if (!branchStats[branch]) {
                    branchStats[branch] = { CÓ: 0, KHÔNG: 0, CHUA: 0, count: 0 };
                }
                branchStats[branch].CÓ += CÓ;
                branchStats[branch].KHÔNG += KHÔNG;
                branchStats[branch].CHUA += CHUA;
                branchStats[branch].count += count;
            }

            const labels = [];
            const dataYes = [];
            const dataNo = [];
            const dataNA = [];

            for (const [branch, stats] of Object.entries(branchStats)) {
                const total = stats.CÓ + stats.KHÔNG + stats.CHUA;
                const safeTotal = total === 0 ? 1 : total;

                labels.push(branch);
                dataYes.push(parseFloat(((stats.CÓ / safeTotal) * 100).toFixed(2)));
                dataNo.push(parseFloat(((stats.KHÔNG / safeTotal) * 100).toFixed(2)));
                dataNA.push(parseFloat(((stats.CHUA / safeTotal) * 100).toFixed(2)));
            }




            const ctx = document.getElementById('branchBarChart').getContext('2d');
            chartContainer.classList.remove('hidden');

            // 🧼 Gỡ biểu đồ cũ nếu có
            if (branchChart) {
                branchChart.destroy();
            }

            branchChart = new Chart(ctx, {

                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: '% CÓ', data: dataYes, backgroundColor: 'rgba(0, 176, 80, 0.6)' },
                        { label: '% KHÔNG', data: dataNo, backgroundColor: 'rgba(255, 0, 0, 0.6)' },
                        { label: '% CHƯA KIỂM TRA', data: dataNA, backgroundColor: 'rgba(165, 165, 165, 0.6)' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#000',
                            font: { weight: 'bold', size: 16 },
                            formatter: function (value) {
                                return value.toFixed(2) + '%';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Tỷ lệ (%)'
                            }
                        }
                    }
                },

                plugins: [ChartDataLabels] // 🟢 THÊM DÒNG NÀY

            });

            // Tạo biểu đồ doughnut cho từng danh mục
            const pieChartContainer = document.getElementById('pieChartContainer');
            pieChartContainer.innerHTML = ''; // clear cũ
            pieChartContainer.classList.remove('hidden');

            // Tạo container grid chứa các biểu đồ tròn
            const pieContainer = document.createElement('div');
            pieContainer.className = 'flex flex-col gap-6 mt-6 items-center';

            pieChartContainer.appendChild(pieContainer);

            // Tạo biểu đồ tròn từng danh mục

            for (const [cat, vals] of Object.entries(categoryTotals)) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col lg:flex-row gap-4 items-start bg-white p-4 rounded shadow';

                // Biểu đồ tròn
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'text-center';

                const canvas = document.createElement('canvas');
                canvas.className = 'w-[240px] h-[240px]';
                chartWrapper.appendChild(canvas);

                const title = document.createElement('div');
                title.className = 'font-semibold text-sm text-gray-800 mt-2';
                title.textContent = cat;
                chartWrapper.appendChild(title);

                wrapper.appendChild(chartWrapper);

                // Bảng chi tiết lỗi
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'overflow-auto w-[800px] min-w-[800px] max-w-[800px] h-[240px]';



                const table = document.createElement('table');
                table.className = 'w-full text-xs text-left text-gray-700 border rounded';

                table.innerHTML = `
<thead class="bg-gray-200 text-gray-900 sticky top-0 z-10">

    <tr>
        <th class="px-2 py-1 border w-[10%] text-center">STT</th>
        <th class="px-2 py-1 border w-[70%]">Lỗi chi tiết</th>
        <th class="px-2 py-1 border w-[20%] text-center">Số lần lỗi</th>
    </tr>
</thead>
<tbody></tbody>
`;


                const tbody = table.querySelector('tbody');
                const errorList = errorSummary[cat] || {};
                const sortedErrors = Object.entries(errorList).sort((a, b) => b[1] - a[1]);

                sortedErrors.forEach(([desc, count], index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td class="px-2 py-1 border text-center">${index + 1}</td>
            <td class="px-2 py-1 border">${desc}</td>
            <td class="px-2 py-1 border text-center">${count}</td>
        `;
                    tbody.appendChild(row);
                });

                tableWrapper.appendChild(table);
                wrapper.appendChild(tableWrapper);

                pieContainer.appendChild(wrapper);

                // Vẽ biểu đồ tròn
                new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: ['CÓ', 'KHÔNG', 'CHƯA KIỂM TRA'],
                        datasets: [{
                            data: [vals["CÓ"], vals["KHÔNG"], vals["CHƯA KIỂM TRA"]],
                            backgroundColor: ['#00B050', '#FF0000', '#A5A5A5']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 26
                                },
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return value > 0
                                        ? `${((value / total) * 100).toFixed(1)}%`
                                        : '';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // ✅ Tạo chú thích chung bên dưới
            const legendWrapper = document.createElement('div');
            legendWrapper.className = 'flex justify-center items-center gap-6 mt-6 flex-wrap text-sm text-gray-800 font-medium';

            const legends = [
                { color: '#00B050', label: 'CÓ' },
                { color: '#FF0000', label: 'KHÔNG' },
                { color: '#A5A5A5', label: 'CHƯA KIỂM TRA' }
            ];

            legends.forEach(({ color, label }) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-2';

                const box = document.createElement('div');
                box.className = 'w-4 h-4 rounded';
                box.style.backgroundColor = color;

                const text = document.createElement('span');
                text.textContent = label;

                item.appendChild(box);
                item.appendChild(text);
                legendWrapper.appendChild(item);
            });

            pieChartContainer.appendChild(legendWrapper);

            // Hiển thị bảng báo cáo chi nhánh
            const branchReportContainer = document.getElementById('branchReportContainer');
            const branchReportBody = document.getElementById('branchReportBody');
            branchReportBody.innerHTML = '';
            branchReportContainer.classList.remove('hidden');

            let index = 1; // Khởi tạo STT
            for (const file of files) {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const { supervisor, fullName, email, area, branch, date, CÓ, KHÔNG, "CHƯA KIỂM TRA": CHUA, totalCriteria } = getSummaryFromSheet(sheet, file.name);

                const row = document.createElement('tr');
                row.className = 'border-b';

                row.innerHTML = `
        <td class="py-2 px-4 text-center">${index}</td>
        <td class="py-2 px-4">${supervisor}</td>
        <td class="py-2 px-4">${fullName}</td> 
        <td class="py-2 px-4">${email}</td>
        <td class="py-2 px-4">${area}</td>  
        <td class="py-2 px-4">${branch}</td>
        <td class="py-2 px-4">${date}</td>
        <td class="py-2 px-4 text-center">${totalCriteria}</td>
        <td class="py-2 px-4 text-center">${CÓ}</td>
        <td class="py-2 px-4 text-center">${KHÔNG}</td>
        <td class="py-2 px-4 text-center">${CHUA}</td>
    `;

                branchReportBody.appendChild(row);
                index++;
            }

            updateBranchReportFooter();

        });
        // Thêm hàm tính tổng và hiển thị footer
        function updateBranchReportFooter() {
            const footer = document.getElementById('branchReportFooter');
            footer.innerHTML = '';
            footer.classList.remove('hidden');

            let totalCriteriaSum = 0, coSum = 0, khongSum = 0, chuaSum = 0;

            document.querySelectorAll("#branchReportBody tr").forEach(tr => {
                totalCriteriaSum += Number(tr.children[7].textContent);
                coSum += Number(tr.children[8].textContent);
                khongSum += Number(tr.children[9].textContent);
                chuaSum += Number(tr.children[10].textContent);
            });

            const footerRow = document.createElement('tr');
            footerRow.innerHTML = `
        <td class="py-2 px-4 text-center" colspan="7">TỔNG CỘNG</td>
        <td class="py-2 px-4 text-center">${totalCriteriaSum}</td>
        <td class="py-2 px-4 text-center">${coSum}</td>
        <td class="py-2 px-4 text-center">${khongSum}</td>
        <td class="py-2 px-4 text-center">${chuaSum}</td>
    `;
            footer.appendChild(footerRow);
        }
    </script>
</body>

</html>